<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejercicio de Español - Diálogo</title>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Estilos para la página de inicio */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 5px;
        }
        
        .item-container {
            margin-bottom: 40px;
            width: 100%;
            max-width: 800px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 36px;
        }
        
        p {
            color: #636e72;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 25px;
        }
        
        .btn-start {
            display: block;
            margin: 30px auto 0 auto;
            background-color: #4285f4;
            text-align: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            padding: 15px 40px;
            border-radius: 50px;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            margin-top: 10px;
        }
        
        .btn-start:hover {
            background-color: #3367d6;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        
        .icon {
            font-size: 80px;
            color: #4285f4;
            margin-bottom: 20px;
        }
        
        .features {
            display: flex;
            justify-content: space-around;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .feature {
            flex: 0 0 28%;
            padding: 15px;
            margin: 10px 0;
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .feature i {
            font-size: 32px;
            color: #4285f4;
            margin-bottom: 10px;
        }
        
        .feature h3 {
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .feature p {
            font-size: 14px;
            margin-bottom: 0;
        }
        
        /* Estilos para la tarjeta de tarea */
        .task-card {
            background-color: #f8f9fa;
            border-left: 5px solid #4285f4;
            border-radius: 8px;
            padding: 20px;
            margin: 30px 0;
            text-align: left;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .task-card h2 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .task-card p {
            color: #636e72;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .task-card ul {
            padding-left: 20px;
            margin-bottom: 0;
        }
        
        .task-card li {
            color: #636e72;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        /* Estilos para el ejercicio */
        .exercise-screen {
            display: none; /* Inicialmente oculto */
        }
        
        .dialogo {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .botones {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .botones button {
            padding: 8px 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .botones button:hover {
            background-color: #3367d6;
        }
        
        .respuesta {
            border: 1px dashed #ccc;
            padding: 8px 12px;
            min-width: 200px;
            display: inline-block;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .puntuacion {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            padding: 15px;
            background-color: #e8f0fe;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .usuario-info {
            text-align: right;
            margin-bottom: 15px;
            font-style: italic;
            color: #666;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .dialogo p {
            margin: 15px 0;
            line-height: 1.6;
        }
        
        .dialogo strong {
            color: #1a73e8;
        }
        
        .correct {
            border-color: #0f9d58;
            background-color: #e6f4ea;
        }
        
        .error {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Estilos para la tabla en SweetAlert */
        .swal2-html-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-family: sans-serif;
        }

        .swal2-html-container th,
        .swal2-html-container td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .swal2-html-container th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .swal2-html-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .swal2-html-container tr:hover {
            background-color: #eee;
        }

        /* Estilo para la línea vertical */
        .swal2-html-container td:first-child {
            border-right: 1px solid #ddd;
        }

        /* Estilos para el botón "Mostrar Resultados" */
        #mostrarResultados {
            display: block;
            padding: 8px;
            margin: 0;
            margin-right: 5px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        #mostrarResultados:hover {
            background-color: #0056b3;
        }

        #mostrarResultados:active {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .sombra {
            background-color: #ccc;
            padding: 5px 5px;
            margin: 5px 0;
        }
        
        .sombra1 {
            background-color: #f0efef;
            padding: 5px 5px;
            margin: 5px 0;
        }
        
        @media (max-width: 768px) {
            .welcome-screen {
                padding: 30px 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            .features {
                flex-direction: column;
            }
            
            .feature {
                flex: 0 0 100%;
                margin: 10px 0;
            }
            
            .task-card {
                padding: 15px;
            }
            
            .task-card h2 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla de bienvenida -->
        <div id="welcome-screen"  style="margin: 0;">
            <header  style="background:#c4c3c3; padding: 20px 0; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; animation: fadeIn 1s ease-in-out;" >
                <h1  style="font-size: 30px; font-weight: bold; color: #333; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1); margin: 0;">
                    Tarea 3
                </h1>
                <h2 style="font-size: 20px; font-weight: bold; color: #074991; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); margin: 10px 0 0;">
                    Diálogo en una situación imaginaria
                </h2>
            </header>
            <header style="background: linear-gradient(135deg, #0f2fb3, #a8a6a6); padding: 20px; margin-bottom: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); ">
                <h6 style="color: #f2f0f4; text-align: center; margin: 0; font-size: 20px; font-weight: bold;animation: pulse 1s infinite;">
                    Un viaje de un fin de semana
                </h6>
            </header>

            <div class="card item-container" id="instrucciones"  style="border: none; border-radius: 15px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                <!-- Encabezado de la tarjeta -->
                <div class="card-header" style="background-color: #343a40; padding: 10px; color: white; font-size: 22px; font-weight: bold; border-bottom: 2px solid #6c757d;">
                    <i class="fas fa-info-circle" style="margin-right: 10px;"></i> Instrucciones
                </div>
                <!-- Cuerpo de la tarjeta -->
                <div class="card-body" style="background-color: #f5f7fa; padding: 20px;">
                    <ul>
                        <li>Usted y sus amigos quieren organizar un viaje de un fin de semana.</li>
                        <li>El examinador es su amigo. Hable con él siguiendo estas indicaciones.</li>
                    </ul>
                    </div>
            </div>
            <div class="card item-container" id="instrucciones" style="border: none; border-radius: 15px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                <!-- Encabezado de la tarjeta -->
                <div class="card-header" style="background-color: #343a40; padding: 10px; color: white; font-size: 22px; font-weight: bold; border-bottom: 2px solid #6c757d;">
                    <i class="fas fa-user-tie" style="margin-right: 10px;"></i> Candidato
                </div>
                <!-- Cuerpo de la tarjeta -->
                <div class="card-body" style="background-color: #f1ece3; padding: 20px;">
                    <strong><p style="font-size: 18px; color: #333333; margin-bottom: 15px;">Durante la conversación, debe:</p></strong>
                    <!-- Lista de elementos con íconos modernos -->
                    <ul style="list-style-type: none; padding-left: 0; margin-bottom: 0;">
                        <li><i class="fas fa-map-marker-alt" style="color: #40E0D0; margin-right: 10px;"></i>Decidir adónde y cuándo van a hacer el viaje;</li>
                        <li><i class="fas fa-car-side" style="color: #FF6B6B; margin-right: 4px;"></i>Pensar si van a ir en coche o transporte público;</li>
                        <li><i class="fas fa-calendar-alt" style="color: #6A5ACD; margin-right: 10px;"></i>Elegir qué van a hacer durante el viaje;</li>
                        <li><i class="fas fa-user-friends" style="color: #FFA500; margin-right: 5px;"></i>Decidir si van a invitar a otros amigos.</li>                      
                    </ul>
                </div>
            </div>
    
       
            
            <button class="btn-start" onclick="comenzarEjercicio()">
                Empezar <i class="bi bi-arrow-right"></i>
            </button>
        </div>
        
        <!-- Pantalla del ejercicio (inicialmente oculta) -->
        <div id="exercise-screen" class="exercise-screen">
            <div class="dialogo">
                <div id="usuario-info" class="usuario-info">Estudiante: <span id="nombre-usuario"></span></div>
                <div class="puntuacion" style="padding: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <div id="puntuacion" style="flex: 1; text-align: center;">Puntuación: 20/20</div>
                    <button id="mostrarResultados" style="padding: 8px; margin: 0;margin-right: 5px;">
                    <i class="bi bi-trophy"></i>
                    </button>
                </div>
                
                <div class="sombra"><p><strong>Amigo:</strong> ¿Quieres hacer un viaje este fin de semana?</p></div>
                
                <div class="sombra1"><div id="botones1" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta1" class="respuesta">&nbsp;</span></p></div>
                
                <div class="sombra"><p><strong>Amigo:</strong> No lo sé. ¿Tienes alguna buena idea?</p></div>

                <div class="sombra1"> <div id="botones2" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta2" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> Prefiero montaña. ¿Conoces algún lugar bonito?</p></div>

                <div class="sombra1"><div id="botones3" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta3" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> Vale. ¿Qué días serían mejores para ti?</p></div>

                <div class="sombra1"><div id="botones4" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta4" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> ¿Vamos en tu coche o transporte público?</p></div>

                <div class="sombra1"><div id="botones5" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta5" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> Sí, tres. ¿Invitamos a Laura también?</p></div>

                <div class="sombra1"><div id="botones6" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta6" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> Llámales tú. ¿Qué haremos durante el viaje?</p></div>

                <div class="sombra1"><div id="botones7" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta7" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> Perfecto. ¿Dónde nos quedaremos a dormir?</p></div>

                <div class="sombra1"><div id="botones8" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta8" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> ¿Puedes reservarla tú hoy por favor?</p></div>

                <div class="sombra1"><div id="botones9" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta9" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> Nada más. Gracias por tu ayuda.</p></div>

                <div class="sombra1"><div id="botones10" class="botones"></div>
                <p><strong>Tú:</strong> <span id="respuesta10" class="respuesta">&nbsp;</span></p></div>

                <div class="sombra"><p><strong>Amigo:</strong> ¡Hasta mañana! Que tengas buen día.</p></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
       // Variables globales
let puntuacion = 20;
const respuestasCorrectas = [
    ["¡Sí!", "¿Adónde", "podríamos", "ir", "juntos?"],
    ["Podríamos", "ir", "a", "la", "montaña", "o", "playa."],
    ["Valverde", "es", "pequeño", "pero", "muy", "acogedor."],
    ["Sábado", "por", "mañana", "hasta", "domingo", "tarde."],
    ["Coche", "es", "mejor.", "¿Tienes", "plazas", "libres?"],
    ["Sí,", "y", "a", "Pablo.", "¿Les", "llamamos?"],
    ["Senderismo,", "comer", "bien", "y", "jugar", "juegos."],
    ["Casa", "rural", "sería", "cómoda", "para", "todos."],
    ["Sí.", "¿Necesitas", "algo", "más", "para", "organizar?"],
    ["De", "nada.", "Hablamos", "mañana", "para", "detalles."]
];
        let respuestasSeleccionadas = [[], [], [], [], [], [], [], [], [], []];
        let nombreUsuario = "";
        let apellidoUsuario = "";

        // Función para cambiar entre pantallas
        function comenzarEjercicio() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('exercise-screen').style.display = 'block';
            
            // Iniciar el ejercicio
            iniciarSolicitudDatosUsuario();
        }
        
        // Función para iniciar la solicitud de datos del usuario
        async function iniciarSolicitudDatosUsuario() {
            // Verificar si ya tenemos datos del usuario
            nombreUsuario = localStorage.getItem('nombreUsuario');
            apellidoUsuario = localStorage.getItem('apellidoUsuario');
            
            if (!nombreUsuario) {
                // Solicitar datos si no existen
                const resultado = await solicitarDatosUsuario();
                
                if (resultado.isConfirmed) {
                    // Guardar datos
                    nombreUsuario = resultado.value.nombre;
                    apellidoUsuario = resultado.value.apellido || "";
                    
                    localStorage.setItem('nombreUsuario', nombreUsuario);
                    localStorage.setItem('apellidoUsuario', apellidoUsuario);
                    
                    // Mensaje de bienvenida
                    await Swal.fire({
                        title: `¡Bienvenido, ${nombreUsuario} ${apellidoUsuario}!`,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Inicializar ejercicio
                    inicializarEjercicio();
                }
            } else {
                // Inicializar directamente si ya tenemos datos
                inicializarEjercicio();
            }
        }

        // Funciones de sonido
        function reproducirSonidoAcertado() {
            new Audio('https://fawzinoo.github.io/Rep/success-2.mp3').play().catch(e => console.log("Error al reproducir sonido:", e));
        }

        function reproducirSonidoExito() {
            new Audio('https://fawzinoo.github.io/Rep/success-1-6297.mp3').play().catch(e => console.log("Error al reproducir sonido:", e));
        }

        function reproducirSonidoError() {
            new Audio('https://www.myinstants.com/media/sounds/app-error.mp3').play().catch(e => console.log("Error al reproducir sonido:", e));
        }

        // URLs de los archivos de audio para las respuestas del usuario
        const audioRespuestas = [
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746203467912689413-264809045143624.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204005492190677-264811219173452.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204054974456019-264811176038489.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204129453384823-264811123126446.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204189806095298-264811215364214.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204222612416387-264812224237635.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204291530414978-264812091158705.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204337872608725-264812623663179.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204398554368113-264812623663206.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746204526393540724-264813250175071.mp3"
        ];

        // URLs de los archivos de audio del amigo (global)
        const archivosAudio = [
            "https://cdn.hailuoai.video/moss/prod/2025-05-02-23/moss-audio/user_audio//1746199007340548843-264790603296860.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-02-23/moss-audio/user_audio//1746199192896854385-264791425204306.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746201812472303173-264801596113080.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746201933588006094-264802792632391.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746202025350917927-264802809507948.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746202062891763996-264803285463176.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746202360951300283-264804078043314.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746202416023356648-264804169236597.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746202506108597681-264804949254226.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746202545737937166-264804949254241.mp3",
            "https://cdn.hailuoai.video/moss/prod/2025-05-03-00/moss-audio/user_audio//1746202581155815128-264805089644645.mp3"
        ];

        // Nueva función para reproducir el audio de las respuestas
        function reproducirAudioRespuesta(index) {
            // Asegurarse de detener cualquier audio que esté reproduciéndose
            if (audioActual) {
                audioActual.pause();
                audioActual = null;
                
                // Restaurar todos los botones a su estado original
                document.querySelectorAll('.audio-btn').forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-play"></i>';
                    btn.classList.remove('reproduciendo');
                });
            }
            
            // Crear un nuevo objeto de audio con la URL de la respuesta actual
            const audioRespuesta = new Audio(audioRespuestas[index]);
            
            // Añadir un pequeño retraso para que no se solape con el sonido de éxito
            setTimeout(() => {
                audioRespuesta.play().catch(error => {
                    console.error("Error al reproducir el audio de la respuesta:", error);
                });
            }, 1000);
        }

        // Función para agregar palabras a las respuestas
        function agregarPalabra(id, palabra, index, boton) {
    const respuestaDiv = document.getElementById(id);
    const palabraEsperada = respuestasCorrectas[index][respuestasSeleccionadas[index].length];
    const puntuacionDiv = document.getElementById("puntuacion");

    if (palabra === palabraEsperada) {
        // Respuesta correcta
        respuestasSeleccionadas[index].push(palabra);
        respuestaDiv.textContent = respuestasSeleccionadas[index].join(" ");
        boton.remove();
        reproducirSonidoAcertado();

        if (respuestasSeleccionadas[index].length === respuestasCorrectas[index].length) {
            // Frase completada
            respuestaDiv.classList.add("correct");
            reproducirSonidoExito();
            
            // Reproducir el audio de la respuesta completa
            if (typeof reproducirAudioRespuesta === 'function') {
                reproducirAudioRespuesta(index);
            }
            
            // Verificar si todas las frases han sido completadas
            const todasCompletadas = respuestasSeleccionadas.every((respuesta, i) => 
                respuesta.length === respuestasCorrectas[i].length
            );
            
            if (todasCompletadas) {
                // Añadir un retraso de 3 segundos para permitir que se reproduzca el audio
                setTimeout(() => {
                    mostrarResultadosFinales();
                }, 6000); // 3000 ms = 3 segundos
            }
        }
    } else {
        // Respuesta incorrecta
        puntuacion = Math.max(0, puntuacion - 1);
        puntuacionDiv.textContent = `Puntuación: ${puntuacion}/20`;
        reproducirSonidoError();
        
        // Efecto visual de error
        boton.classList.add("error");
        setTimeout(() => {
            boton.classList.remove("error");
        }, 500);
    }
}

        // Función para mezclar arrays
        function mezclarArray(array) {
            const nuevoArray = [...array];
            for (let i = nuevoArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [nuevoArray[i], nuevoArray[j]] = [nuevoArray[j], nuevoArray[i]];
            }
            return nuevoArray;
        }

        // Función para generar botones de palabras
        function generarBotones(palabras, id, index) {
            const contenedor = document.getElementById(id);
            contenedor.innerHTML = ""; // Limpiar contenedor
            
            mezclarArray([...palabras]).forEach(palabra => {
                const boton = document.createElement("button");
                boton.textContent = palabra;
                boton.onclick = () => agregarPalabra(`respuesta${index + 1}`, palabra, index, boton);
                contenedor.appendChild(boton);
            });
        }

        // Función para enviar datos al servidor (con formulario)
        function enviarDatosAlServidor(nombre, apellido, nota) {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyaBd9rv-ThfmHCMYiiMNn8w35tCk9vqvvOpGVypKxvMS_uwwehLmGhleBnlsUO5lEMvw/exec';
            const formData = new FormData();
            formData.append('nombre', nombre);
            formData.append('apellido', apellido);
            formData.append('nota', nota);

            return fetch(scriptURL, {
                method: 'POST',
                body: formData
            });
        }

        // Función para mostrar resultados finales - modificada
async function mostrarResultadosFinales() {
    // Guardar puntuación en localStorage
    localStorage.setItem('puntuacionDialogo', puntuacion.toString());
    
    // Obtener datos del usuario
    nombreUsuario = localStorage.getItem('nombreUsuario') || "Anónimo";
    apellidoUsuario = localStorage.getItem('apellidoUsuario') || "";
    
    // Mostrar mensaje de éxito
    Swal.fire({
        title: '¡Ejercicio completado!',
        html: `
            <p>Has obtenido una puntuación de <strong>${puntuacion}/20</strong></p>
            <p><small>Nombre: ${nombreUsuario} ${apellidoUsuario}</small></p>
        `,
        icon: 'success',
        confirmButtonText: 'Entendido',
        allowOutsideClick: false
    }).then(async (result) => {
        if (result.isConfirmed) {
            // Añadir el botón de reproducir conversación completa después de pulsar "Entendido"
            agregarBotonReproduccionCompleta();
            
            // Mostrar carga mientras se envían los datos
            Swal.fire({
                title: 'Enviando resultados...',
                html: 'Por favor espera mientras guardamos tus resultados',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Intentar enviar datos
            try {
                await enviarDatosAlServidor(nombreUsuario, apellidoUsuario, puntuacion);
                Swal.fire({
                    title: '¡Éxito!',
                    text: 'Tus resultados han sido guardados correctamente.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudo conectar con el servidor. Por favor inténtalo nuevamente más tarde.',
                    icon: 'error'
                });
            }
        }
    });
}

        // Función para solicitar datos del usuario
        function solicitarDatosUsuario() {
            return Swal.fire({
                title: 'Bienvenido al ejercicio',
                html: `
                    <input id="swal-nombre" class="swal2-input" placeholder="Nombre" required>
                    <input id="swal-apellido" class="swal2-input" placeholder="Apellido">
                `,
                confirmButtonText: 'Comenzar',
                allowOutsideClick: false,
                allowEscapeKey: false,
                preConfirm: () => {
                    const nombre = document.getElementById('swal-nombre').value.trim();
                    const apellido = document.getElementById('swal-apellido').value.trim();
                    
                    if (!nombre) {
                        Swal.showValidationMessage('Por favor ingresa al menos tu nombre');
                        return false;
                    }
                    
                    return { nombre, apellido };
                }
            });
        }

        // Función para inicializar el ejercicio
        function inicializarEjercicio() {
            // Actualizar puntuación
            document.getElementById("puntuacion").textContent = `Puntuación: ${puntuacion}/20`;
            
            // Mostrar nombre del usuario
            nombreUsuario = localStorage.getItem('nombreUsuario');
            apellidoUsuario = localStorage.getItem('apellidoUsuario');
            document.getElementById("nombre-usuario").textContent = `${nombreUsuario} ${apellidoUsuario}`;
            
            // Generar botones para cada ejercicio
          // Generar botones para cada ejercicio
generarBotones(["¡Sí!", "¿Adónde", "podríamos", "ir", "juntos?"], "botones1", 0);
generarBotones(["Podríamos", "ir", "a", "la", "montaña", "o", "playa."], "botones2", 1);
generarBotones(["Valverde", "es", "pequeño", "pero", "muy", "acogedor."], "botones3", 2);
generarBotones(["Sábado", "por", "mañana", "hasta", "domingo", "tarde."], "botones4", 3);
generarBotones(["Coche", "es", "mejor.", "¿Tienes", "plazas", "libres?"], "botones5", 4);
generarBotones(["Sí,", "y", "a", "Pablo.", "¿Les", "llamamos?"], "botones6", 5);
generarBotones(["Senderismo,", "comer", "bien", "y", "jugar", "juegos."], "botones7", 6);
generarBotones(["Casa", "rural", "sería", "cómoda", "para", "todos."], "botones8", 7);
generarBotones(["Sí.", "¿Necesitas", "algo", "más", "para", "organizar?"], "botones9", 8);
generarBotones(["De", "nada.", "Hablamos", "mañana", "para", "detalles."], "botones10", 9);
        }

        // Añade este código al final de tu script JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('mostrarResultados').addEventListener('click', function() {
                obtenerYMostrarResultados();
            });
        });

        async function obtenerYMostrarResultados() {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyaBd9rv-ThfmHCMYiiMNn8w35tCk9vqvvOpGVypKxvMS_uwwehLmGhleBnlsUO5lEMvw/exec'; // Reemplaza con la URL de tu script
            try {
                const response = await fetch(scriptURL + '?action=obtenerResultados');
                const data = await response.json();

                if (data.status === 'success') {
                    const resultados = data.resultados;

                    let tablaHTML = '';

                    if (resultados.length > 1) { // Aseguramos que hay al menos una fila de datos reales
                        // Saltamos la primera fila que contiene encabezados
                        const datosSinEncabezado = resultados.slice(1);

                        // Ordenamos por la nota (columna 3)
                        datosSinEncabezado.sort(function(a, b) {
                            return b[2] - a[2];
                        });

                        tablaHTML = '<table style="width: 100%; border-collapse: collapse;">';
                        tablaHTML += '<thead><tr><th>Nombre y Apellido</th><th>Nota</th></tr></thead>';
                        tablaHTML += '<tbody>';

                        datosSinEncabezado.forEach((resultado, index) => {
                            const nombre = resultado[0].trim();
                            const apellido = resultado[1].trim();
                            const nota = resultado[2];

                            // Validar que el nombre y apellido no estén vacíos
                            if (nombre && apellido) {
                                const nombreInicial = nombre.charAt(0).toUpperCase();
                                let icono = '';
                                if (index === 0) { // Primer lugar
                                    icono = '<i class="bi bi-trophy-fill" style="color: gold; margin-left: 5px;"></i>';
                                } else if (index === 1) { // Segundo lugar - Medalla de oro
                                    icono = '<i class="bi bi-award-fill" style="color: gold; margin-left: 5px;"></i>';
                                } else if (index === 2) { // Tercer lugar - Medalla de bronce
                                    icono = '<i class="bi bi-award-fill" style="color: #CD7F32; margin-left: 5px;"></i>';
                                }
                                tablaHTML += `<tr><td style="border-right: 1px solid #ddd;">${nombreInicial}. ${apellido}${icono}</td><td>${nota}</td></tr>`;
                            }
                        });

                        tablaHTML += '</tbody></table>';
                    } else {
                        tablaHTML = '<p>No hay resultados disponibles.</p>';
                    }

                    Swal.fire({
                        title: 'Resultados',
                        html: tablaHTML,
                        confirmButtonText: 'Cerrar',
                        width: '80%' // Ajusta el ancho del SweetAlert
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message,
                        icon: 'error'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudo obtener los resultados. Por favor, inténtalo de nuevo más tarde.',
                    icon: 'error'
                });
            }
        }

        // Función para agregar botones de audio a los mensajes del amigo
        function agregarBotonesAudio() {
            // Estilos para el botón de audio
            document.head.insertAdjacentHTML('beforeend', `
            <style>
                .audio-btn {
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: #4285f4;
                    border: none;
                    width: 36px;
                    height: 36px;
                    border-radius: 50%;
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                }
                
                .audio-btn:hover {
                    background: #3367d6;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                    transform: translateY(-50%) scale(1.05);
                }
                
                .audio-btn:active {
                    transform: translateY(-50%) scale(0.95);
                }
                
                .audio-btn i {
                    font-size: 16px;
                }
                
                .sombra {
                    position: relative;
                    padding-right: 50px;
                }
                
                .reproduciendo {
                    background: #0f9d58;
                }
            </style>
            `);

            // Array con los textos del amigo
            const frasesAmigo = [
                "¿Quieres hacer un viaje este fin semana?",
                "No lo sé. ¿Tienes alguna buena idea?",
                "Prefiero montaña. ¿Conoces algún lugar bonito?",
                "Vale. ¿Qué días serían mejores para ti?",
                "¿Vamos en tu coche o transporte público?",
                "Sí, tres. ¿Invitamos a Laura también?",
                "Llámales tú. ¿Qué haremos durante el viaje?",
                "Perfecto. ¿Dónde nos quedaremos a dormir?",
                "¿Puedes reservarla tú hoy por favor?",
                "Nada más. Gracias por tu ayuda.",
                "¡Hasta mañana! Que tengas buen día."
            ];
            
            // Seleccionar todos los divs de clase "sombra" (mensajes del amigo)
            const divsMensajesAmigo = document.querySelectorAll('.sombra');
            
            // Iterar sobre cada div y añadir el botón de audio
            divsMensajesAmigo.forEach((div, index) => {
                if (index < frasesAmigo.length) {
                    // Crear el botón de audio
                    const botonAudio = document.createElement('button');
                    botonAudio.className = 'audio-btn';
                    botonAudio.innerHTML = '<i class="fas fa-play"></i>';
                    botonAudio.title = 'Reproducir audio';
                    botonAudio.dataset.texto = frasesAmigo[index];
                    botonAudio.dataset.index = index;
                    
                    // Agregar evento de clic
                    botonAudio.addEventListener('click', function() {
                        const indice = this.dataset.index;
                        reproducirAudioMensaje(indice, this);
                    });
                    
                    // Añadir botón al div
                    div.appendChild(botonAudio);
                }
            });
        }

        // Crear una variable global para el audio actual
        let audioActual = null;

        // Función para reproducir el audio de un mensaje
        function reproducirAudioMensaje(indice, boton) {
    // Detener cualquier audio que se esté reproduciendo
    if (audioActual) {
        audioActual.pause();
        audioActual = null;
        
        // Restaurar todos los botones a su estado original
        document.querySelectorAll('.audio-btn').forEach(btn => {
            btn.innerHTML = '<i class="fas fa-play"></i>';
            btn.classList.remove('reproduciendo');
        });
    }
    
    // Crear un nuevo objeto de audio
    audioActual = new Audio(archivosAudio[indice]);
    
    // Cambiar el icono a "pausa"
    boton.innerHTML = '<i class="fas fa-pause"></i>';
    boton.classList.add('reproduciendo');
    
    // Reproducir el audio
    audioActual.play().catch(error => {
        console.error("Error al reproducir el audio:", error);
        // Ya no usamos la síntesis de voz como respaldo
        boton.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
        setTimeout(() => {
            boton.innerHTML = '<i class="fas fa-play"></i>';
            boton.classList.remove('reproduciendo');
        }, 1000);
    });
    
    // Cuando termine el audio, restaurar el botón
    audioActual.onended = function() {
        boton.innerHTML = '<i class="fas fa-play"></i>';
        boton.classList.remove('reproduciendo');
        audioActual = null;
    };
}

// Modificar la función inicializarEjercicio para que NO agregue el botón al inicio
const funcionOriginalInit = inicializarEjercicio;
inicializarEjercicio = function() {
    funcionOriginalInit();
    agregarBotonesAudio();
    // Quitamos esta línea para que el botón no se muestre al inicio
    // agregarBotonReproduccionCompleta();
};

        // Agregar esta función para añadir el botón de reproducción completa
function agregarBotonReproduccionCompleta() {
    // Crear el botón de reproducción completa con estilo minimalista
    const botonReproduccionCompleta = document.createElement('button');
    
    // Nuevo estilo minimalista
    botonReproduccionCompleta.style.cssText = `
    background: linear-gradient(90deg, #4285f4 0%, #0f9d58 100%);
    border: none;
    color: #fff;
    padding: 12px 32px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 28px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: block; /* Cambiado de inline-flex a block para poder centrarlo */
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin: 24px auto; /* auto en los márgenes horizontales centra el elemento */
    box-shadow: 0 3px 15px rgba(66, 133, 244, 0.15);
    outline: none;
    letter-spacing: 0.6px;
    min-width: 220px;
    position: relative;
    overflow: hidden;
    z-index: 1;
    text-align: center; /* Asegura que el contenido esté centrado */
    
    &:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(66, 133, 244, 0.25);
    }
    
    &:active {
        transform: translateY(1px);
        box-shadow: 0 2px 10px rgba(66, 133, 244, 0.2);
    }
    
    &::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, #0f9d58 0%, #4285f4 100%);
        opacity: 0;
        z-index: -1;
        transition: opacity 0.3s ease;
    }
    
    &:hover::after {
        opacity: 1;
    }
`;

// Después de aplicar el estilo, especificar también:
botonReproduccionCompleta.style.display = 'flex'; // Mantener el flexbox para alinear icono y texto
botonReproduccionCompleta.style.margin = '24px auto'; // Asegurar que esté centrado
    
    // Icono y texto más minimalistas
    botonReproduccionCompleta.innerHTML = '<i class="fas fa-headphones" style="font-size: 14px;"></i> Escuchar diálogo';
    
    // Efectos al pasar el mouse
    botonReproduccionCompleta.onmouseover = function() {
        this.style.backgroundColor = 'rgba(66, 133, 244, 0.1)';
        this.style.transform = 'translateY(-2px)';
    };
    
    botonReproduccionCompleta.onmouseout = function() {
        this.style.backgroundColor = 'transparent';
        this.style.transform = 'translateY(0)';
    };
    
    // Agregar evento al botón
    botonReproduccionCompleta.addEventListener('click', reproducirConversacionCompleta);
    
    // Agregar el botón al final del diálogo
    document.querySelector('.dialogo').appendChild(botonReproduccionCompleta);
}

 

        // Función para reproducir toda la conversación en orden - versión modificada
function reproducirConversacionCompleta() {
    // Reiniciar la variable de control al iniciar una nueva reproducción
    window.reproduccionDetenida = false;

    // Referencia a los arrays de audio existentes
    const audiosAmigo = archivosAudio; // Array ya definido en reproducirAudioMensaje
    const audiosUsuario = audioRespuestas; // Array global ya definido
    
    // Crear una conversación intercalando amigo y usuario
    const conversacionCompleta = [];
    
    // Obtener todos los divs de clase "sombra" y "sombra1"
    const divsMensajesAmigo = document.querySelectorAll('.sombra');
    const divsMensajesUsuario = document.querySelectorAll('.sombra1');
    
    // Determinar el número máximo de intercambios posibles (sin incluir el último mensaje del amigo)
    const maxIntercambios = Math.min(audiosAmigo.length - 1, audiosUsuario.length);
    
    // Construir la conversación alternando mensajes
    for (let i = 0; i < maxIntercambios; i++) {
        // Agregar mensaje del amigo
        conversacionCompleta.push({
            url: audiosAmigo[i],
            rol: "amigo",
            elemento: divsMensajesAmigo[i]
        });
        
        // Agregar respuesta del usuario si la frase correspondiente está completa
        if (respuestasSeleccionadas[i].length === respuestasCorrectas[i].length) {
            conversacionCompleta.push({
                url: audiosUsuario[i],
                rol: "usuario",
                elemento: divsMensajesUsuario[i]
            });
        }
    }
    
    // Agregar el último mensaje del amigo (despedida)
    const ultimoIndice = audiosAmigo.length - 1;
    conversacionCompleta.push({
        url: audiosAmigo[ultimoIndice],
        rol: "amigo",
        elemento: divsMensajesAmigo[ultimoIndice]
    });
    
    // Agregar estilos para la flecha
    const estiloFlecha = document.createElement('style');
    estiloFlecha.textContent = `
        .flecha-reproduccion {
            position: absolute;
            left: -45px;
            top: 50%;
            transform: translateY(-50%);
            color: #4285f4;
            font-size: 30px;
            animation: moverFlecha 1s infinite alternate;
            text-shadow: 0 0 5px rgba(66, 133, 244, 0.5);
        }
        
        @keyframes moverFlecha {
            0% { transform: translateY(-65%); }
            100% { transform: translateY(-35%); }
        }
        
        .sombra, .sombra1 {
            position: relative;
        }
        
        #boton-detener-reproduccion {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        #boton-detener-reproduccion:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
    `;
    document.head.appendChild(estiloFlecha);
    
    // Crear botón flotante para detener reproducción
    const botonDetener = document.createElement('button');
    botonDetener.id = 'boton-detener-reproduccion';
    botonDetener.innerHTML = '<i class="fas fa-stop"></i>';
    botonDetener.title = 'Detener reproducción';
    document.body.appendChild(botonDetener);
    
    // Evento para detener reproducción
    botonDetener.addEventListener('click', function() {
        // Detener audio actual si existe
        if (audioActual) {
            audioActual.pause();
            audioActual.src = ""; // Liberar recursos
            audioActual = null;
        }
        
        // Eliminar todas las flechas
        document.querySelectorAll('.flecha-reproduccion').forEach(flecha => {
            flecha.remove();
        });
        
        // Eliminar el botón de detener
        this.remove();
        
        // Restaurar todos los botones de audio a su estado original
        document.querySelectorAll('.audio-btn').forEach(btn => {
            btn.innerHTML = '<i class="fas fa-play"></i>';
            btn.classList.remove('reproduciendo');
        });
        
        // Mostrar mensaje de cancelación
        console.log("Reproducción cancelada por el usuario");
        
        // También debemos cancelar cualquier reproducción programada pendiente
        // Para esto podemos usar una variable global para rastrear si se ha detenido
        window.reproduccionDetenida = true;
    });
    
    // Iniciar reproducción secuencial
    reproducirSecuencialmenteConFlecha(conversacionCompleta, 0);
}

// Función mejorada para reproducir los audios secuencialmente con flecha indicadora
function reproducirSecuencialmenteConFlecha(conversacion, indice) {
    // Si ya se reprodujeron todos los audios o se detuvo manualmente, finalizar
    if (indice >= conversacion.length || window.reproduccionDetenida === true) {
        // Eliminar todas las flechas
        document.querySelectorAll('.flecha-reproduccion').forEach(flecha => {
            flecha.remove();
        });
        // Eliminar el botón de detener si existe
        const botonDetener = document.getElementById('boton-detener-reproduccion');
        if (botonDetener) botonDetener.remove();
        
        // Reiniciar la variable de control
        window.reproduccionDetenida = false;
        return;
    }
    
    // Obtener información del audio actual
    const audioInfo = conversacion[indice];
    
    // Eliminar cualquier flecha existente
    document.querySelectorAll('.flecha-reproduccion').forEach(flecha => {
        flecha.remove();
    });
    
    // Crear y añadir la flecha al elemento actual
    const flecha = document.createElement('div');
    flecha.className = 'flecha-reproduccion';
    flecha.innerHTML = '<i class="fas fa-volume-up"></i>';
    audioInfo.elemento.appendChild(flecha);
    
    // Desplazar la vista hacia el elemento actual
    audioInfo.elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Mostrar información de depuración
    console.log(`Intentando reproducir: ${indice+1}/${conversacion.length} - URL: ${audioInfo.url.substring(0, 50)}...`);
    
    // Reproducir el audio actual como una promesa
    reproducirAudioComoPromesa(audioInfo.url)
        .then(() => {
            // Esperar 2 segundos y pasar al siguiente audio
            return new Promise(resolve => setTimeout(resolve, 2000));
        })
        .then(() => {
            // Reproducir el siguiente audio
            reproducirSecuencialmenteConFlecha(conversacion, indice + 1);
        })
        .catch(error => {
            console.error(`Error con audio ${indice+1}:`, error);
            // Continuar con el siguiente audio en caso de error
            setTimeout(() => {
                reproducirSecuencialmenteConFlecha(conversacion, indice + 1);
            }, 2000);
        });
}

// Nueva función auxiliar para reproducir audio como promesa
function reproducirAudioComoPromesa(url) {
    return new Promise((resolve, reject) => {
        // Limpiar el audio anterior si existe
        if (audioActual) {
            audioActual.pause();
            audioActual.src = "";
            audioActual = null;
        }
        
        // Crear nuevo objeto de audio
        const audio = new Audio();
        
        // Configurar manejadores de eventos
        audio.onended = () => {
            audioActual = null;
            resolve();
        };
        
        audio.onerror = (e) => {
            console.error("Error al reproducir audio:", e);
            audioActual = null;
            reject(e);
        };
        
        // Intentar reproducir
        audio.src = url;
        audio.load();
        
        const playPromise = audio.play();
        audioActual = audio;
        
        // Manejar la promesa de reproducción
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("Error durante la reproducción:", error);
                audioActual = null;
                reject(error);
            });
        }
    });
}

    </script>
</body>
</html>
