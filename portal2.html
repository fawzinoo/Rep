<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.15.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.15.10/dist/sweetalert2.all.min.js"></script>
    <link rel="icon" type="image/png" sizes="32x32" href="https://fawzinoo.github.io/Fotos/f.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://fawzinoo.github.io/Fotos/f.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://fawzinoo.github.io/Fotos/f.png">
    <title>Portal de Acceso2 - Español</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #1c1e21;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .global-loading-overlay {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, rgba(8, 56, 215, 0.75), rgba(255, 196, 0, 0.65));
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }

        .global-loading-card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 18px;
            padding: 28px 34px;
            box-shadow: 0 16px 48px rgba(8, 56, 215, 0.25);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            max-width: min(90vw, 360px);
            text-align: center;
        }

        .global-loading-spinner {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: 4px solid rgba(8, 56, 215, 0.18);
            border-top-color: #0838d7;
            animation: globalSpin 1s linear infinite;
        }

        @keyframes globalSpin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .global-loading-message {
            font-size: 18px;
            font-weight: 600;
            color: #0838d7;
        }

        header {
            text-align: center;
            padding: 25px 20px;
            background: linear-gradient(135deg, #0838d7, #4f46e5);
            color: white;
            font-size: 28px;
            font-weight: 800;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            letter-spacing: 1px;
        }

        .portal-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: radial-gradient(circle at center, #f8f9fa 0%, #e9ecef 100%);
            opacity: 1;
            transition: opacity 0.5s ease;
            pointer-events: auto;
        }

        .portal-container.access-granted {
            opacity: 1;
            pointer-events: auto;
        }

        .portal-card {
            background: white;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 25px;
            animation: cardFadeIn 0.6s ease-out;
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .portal-title {
            font-size: 22px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 10px;
        }

        .portal-buttons {
            display: grid;
            gap: 20px;
        }

        .portal-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px 30px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            text-decoration: none;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .portal-btn i {
            font-size: 24px;
        }

        .btn-a1 {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .btn-a1:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-a2 {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
        }

        .btn-a2:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 20px rgba(37, 99, 235, 0.3);
        }

        /* Reutilización de estilos de login de grup2 */
        .swal2-popup.access-gate {
            width: min(420px, calc(100vw - 32px)) !important;
            padding: 14px 16px 18px !important;
            border-radius: 16px !important;
            box-shadow: 0 18px 60px rgba(8, 56, 215, 0.18);
        }

        .gate-fieldset {
            display: grid;
            gap: 10px;
            margin-top: 4px;
        }

        .gate-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .gate-label {
            font-size: 13px;
            color: #4b5563;
            font-weight: 600;
            text-align: left;
        }

        .gate-input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .gate-input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.15);
            background: #ffffff;
        }

        .gate-input-wrapper {
            position: relative;
            width: 100%;
        }

        .gate-input-wrapper .gate-input {
            padding-right: 40px;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            font-size: 16px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .toggle-password:hover {
            color: #7c3aed;
        }

        .editor-name {
            position: fixed;
            bottom: 15px;
            left: 15px;
            font-size: 11px;
            font-weight: bold;
            animation: colorTintineo 3s infinite;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        @keyframes colorTintineo {
            0% {
                color: #ff0000;
            }

            20% {
                color: #ffff00;
            }

            40% {
                color: #00ff00;
            }

            60% {
                color: #00ffff;
            }

            80% {
                color: #ff00ff;
            }

            100% {
                color: #ff0000;
            }
        }

        .logo-corner {
            position: absolute;
            top: 10px;
            left: 15px;
            width: 50px;
            height: 50px;
        }

        .logo-corner img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>

<body style="background-color: #f0f2f5;">

    <header>
        <div class="logo-corner">
            <img src="https://fawzinoo.github.io/Fotos/f.png" alt="Logo">
        </div>
        CURSOS DE ESPAÑOL
    </header>

    <div class="portal-container">
        <div class="portal-card">
            <div class="portal-title">Bienvenido al Portal de Acceso</div>
            <p style="color: #6b7280; font-size: 15px; margin-top: -10px;">Selecciona tu curso para continuar</p>

            <div class="portal-buttons">
                <a href="https://fawzinoo.github.io/Rep/A1grupo2.html" class="portal-btn btn-a1">
                    <i class="fas fa-graduation-cap"></i>
                    Acceder a A1
                </a>
                <a href="https://fawzinoo.github.io/Rep/A2grupo2.html" class="portal-btn btn-a2">
                    <i class="fas fa-layer-group"></i>
                    Acceder a A2.1
                </a>
                <div id="online-users-wrapper"
                    style="display: flex; align-items: center; justify-content: center; gap: 8px; color: #6b7280; font-size: 14px; margin-top: -10px;">
                    <i class="fas fa-circle"
                        style="color: #10b981; font-size: 10px; animation: pulse-green 2s infinite;"></i>
                    <span id="online-count">...</span> <span style="font-size:12px;">usuarios en línea</span>
                </div>
                <style>
                    @keyframes pulse-green {
                        0% {
                            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
                        }

                        70% {
                            box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
                        }

                        100% {
                            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
                        }
                    }
                </style>
            </div>
        </div>
    </div>

    <div class="editor-name">@Faouzi ElHilali</div>

    <script>
        (function enforceAccessGate() {
            const STORAGE_KEYS = {
                first: 'access_first_name',
                last: 'access_last_name',
                code: 'access_code',
                token: 'access_token'
            };
            const SESSION_OK_KEY = 'access_gate_ok';
            const G_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwaWs_zSyqcT_C2StfrgwypWPlKKEZHY_NvU74xqZhnchy8gB6BwyNvJOQSrv-ZVvRl/exec';

            let gatePromptOpen = false;
            let verificationInterval = null;

            const normalizeName = (name) => (name || '').trim().toLowerCase().replace(/\s+/g, ' ');
            const normalizeCode = (code) => (code || '').trim().toUpperCase();

            // Generar token aleatorio
            const generateToken = () => Math.random().toString(36).substring(2) + Date.now().toString(36);

            function showPortal() {
                const container = document.querySelector('.portal-container');
                if (container) container.classList.add('access-granted');
                startVerificationTimer();
            }

            function startVerificationTimer() {
                if (verificationInterval) return;
                verificationInterval = setInterval(async () => {
                    const stillValid = await isStoredAccessValid();
                    if (!stillValid) location.reload();
                }, 30000);
            }

            async function isStoredAccessValid() {
                const storedFirst = normalizeName(localStorage.getItem(STORAGE_KEYS.first) || '');
                const storedLast = normalizeName(localStorage.getItem(STORAGE_KEYS.last) || '');
                const storedCode = normalizeCode(localStorage.getItem(STORAGE_KEYS.code) || '');
                const storedToken = localStorage.getItem(STORAGE_KEYS.token) || '';

                if (!storedFirst || !storedLast || !storedCode) return false;

                try {
                    const response = await fetch(`${G_SCRIPT_URL}?mode=verify&code=${storedCode}&nombre=${encodeURIComponent(storedFirst)}&apellido=${encodeURIComponent(storedLast)}&token=${encodeURIComponent(storedToken)}&t=${Date.now()}`);
                    const data = await response.json();

                    if (data.blocked) {
                        localStorage.removeItem(STORAGE_KEYS.code);
                        sessionStorage.removeItem(STORAGE_KEYS.code);
                        Swal.fire({
                            icon: 'error',
                            title: 'Acceso Bloqueado',
                            text: 'Contacta con tu profesor para más información.',
                            confirmButtonText: 'Entendido',
                            allowOutsideClick: false
                        }).then(() => location.reload());
                        return false;
                    }

                    if (data.valid) {
                        showPortal();
                        return true;
                    } else {
                        // Si el servidor dice inválido (por código incorrecto o token diferente)
                        localStorage.removeItem(STORAGE_KEYS.code);
                        localStorage.removeItem(STORAGE_KEYS.token);
                        return false;
                    }
                } catch (e) {
                    showPortal();
                    return true;
                }
            }

            async function sendPortalData(first, last, code, token) {
                try {
                    await fetch(G_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'portal2',
                            nombre: first,
                            apellido: last,
                            codigo: code,
                            token: token // Enviamos el token nuevo
                        })
                    });
                } catch (e) {
                    console.warn('Error enviando datos al portal', e);
                }
            }

            function saveAccess(first, last, code) {
                const newToken = generateToken(); // Generamos nuevo token de sesión
                localStorage.setItem(STORAGE_KEYS.first, first);
                localStorage.setItem(STORAGE_KEYS.last, last);
                localStorage.setItem(STORAGE_KEYS.code, code);
                localStorage.setItem(STORAGE_KEYS.token, newToken); // Guardamos token

                try { sessionStorage.setItem(SESSION_OK_KEY, 'true'); } catch (_) { }

                sendPortalData(first, last, code, newToken);
                showPortal();
            }

            function askForName() {
                if (gatePromptOpen) return;
                gatePromptOpen = true;
                if (!window.Swal || typeof Swal.fire !== 'function') {
                    document.body.innerHTML = '<div style="padding:24px;font-family:Arial,sans-serif;">Acceso bloqueado. Reinterntar cargando SweetAlert.</div>';
                    gatePromptOpen = false;
                    return;
                }

                Swal.fire({
                    title: 'Ingresa tus datos de acceso',
                    html: `
                    <div class="gate-fieldset">
                        <div class="gate-field">
                            <label class="gate-label" for="swal-first-name">Nombre</label>
                            <input id="swal-first-name" class="gate-input" placeholder="Ej: Juan" autocomplete="off" />
                        </div>
                        <div class="gate-field">
                            <label class="gate-label" for="swal-last-name">Apellido</label>
                            <input id="swal-last-name" class="gate-input" placeholder="Ej: Pérez" autocomplete="off" />
                        </div>
                        <div class="gate-field">
                            <label class="gate-label" for="swal-code">Código de Acceso</label>
                            <div class="gate-input-wrapper">
                                <input id="swal-code" class="gate-input" placeholder="Ingresa tu código" autocomplete="off" type="password" />
                                <button type="button" class="toggle-password" id="toggle-code-visibility" aria-label="Mostrar código">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                    focusConfirm: false,
                    confirmButtonText: 'Verificar y Entrar',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: false,
                    showLoaderOnConfirm: true,
                    customClass: { popup: 'access-gate' },
                    preConfirm: async () => {
                        const first = normalizeName(document.getElementById('swal-first-name')?.value || '');
                        const last = normalizeName(document.getElementById('swal-last-name')?.value || '');
                        const code = normalizeCode(document.getElementById('swal-code')?.value || '');
                        const full = normalizeName(`${first} ${last}`.trim());

                        const storedFirst = normalizeName(localStorage.getItem(STORAGE_KEYS.first) || '');
                        const storedLast = normalizeName(localStorage.getItem(STORAGE_KEYS.last) || '');
                        const storedFull = normalizeName(`${storedFirst} ${storedLast}`.trim());

                        if (!first || !last || !code) {
                            Swal.showValidationMessage('Completa todos los campos.');
                            return false;
                        }

                        // Lógica original: Deben coincidir con los datos del primer registro
                        if (storedFull && full !== storedFull) {
                            Swal.showValidationMessage('Debes usar el mismo nombre y apellido que registraste la primera vez.');
                            return false;
                        }

                        try {
                            const response = await fetch(`${G_SCRIPT_URL}?mode=verify&code=${code}&nombre=${encodeURIComponent(first)}&apellido=${encodeURIComponent(last)}&t=${Date.now()}`);
                            const result = await response.json();

                            if (result.blocked) {
                                Swal.showValidationMessage('Acceso bloqueado. Contacta con tu profesor.');
                                return false;
                            }

                            if (!result.valid) {
                                if (result.reason === 'already_active') {
                                    Swal.showValidationMessage('Ya hay una sesión activa para este usuario en otro dispositivo. El acceso es único.');
                                } else if (result.blocked) {
                                    Swal.showValidationMessage('Acceso bloqueado. Contacta con tu profesor.');
                                } else {
                                    Swal.showValidationMessage('Código incorrecto o no autorizado.');
                                }
                                return false;
                            }

                            return { first, last, code };
                        } catch (error) {
                            Swal.showValidationMessage('Error de conexión con el servidor.');
                            return false;
                        }
                    },
                    didOpen: () => {
                        const firstInput = document.getElementById('swal-first-name');
                        const lastInput = document.getElementById('swal-last-name');
                        const codeInput = document.getElementById('swal-code');

                        const storedFirstRaw = localStorage.getItem(STORAGE_KEYS.first) || '';
                        const storedLastRaw = localStorage.getItem(STORAGE_KEYS.last) || '';
                        if (storedFirstRaw && firstInput) firstInput.value = storedFirstRaw;
                        if (storedLastRaw && lastInput) lastInput.value = storedLastRaw;

                        if (firstInput && !storedFirstRaw) firstInput.focus();
                        else if (codeInput) codeInput.focus();

                        const handleEnter = (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                document.querySelector('.swal2-confirm')?.click();
                            }
                        };
                        [firstInput, lastInput, codeInput].forEach(i => i?.addEventListener('keydown', handleEnter));

                        // Toggle password visibility
                        const toggleBtn = document.getElementById('toggle-code-visibility');
                        if (toggleBtn && codeInput) {
                            toggleBtn.addEventListener('click', () => {
                                const isPassword = codeInput.type === 'password';
                                codeInput.type = isPassword ? 'text' : 'password';
                                toggleBtn.innerHTML = isPassword
                                    ? '<i class="fas fa-eye"></i>'
                                    : '<i class="fas fa-eye-slash"></i>';
                            });
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        saveAccess(result.value.first, result.value.last, result.value.code);
                    } else {
                        askForName();
                    }
                    gatePromptOpen = false;
                });
            }

            document.addEventListener('DOMContentLoaded', async () => {
                const valid = await isStoredAccessValid();
                if (!valid) {
                    askForName();
                } else {
                    // Si ya es válido desde el inicio, el temporizador se activa dentro de showPortal()
                }

                // Iniciar contador de usuarios online
                updateOnlineCount();
                setInterval(updateOnlineCount, 5000); // Actualizar cada 10s
            });

            async function updateOnlineCount() {
                try {
                    const response = await fetch(`${G_SCRIPT_URL}?mode=online_count&t=${Date.now()}`);
                    const count = await response.text();
                    const counterEl = document.getElementById('online-count');
                    const wrapperEl = document.getElementById('online-users-wrapper');

                    if (counterEl && document.body.contains(counterEl)) {
                        counterEl.textContent = count;
                    }
                } catch (e) {
                    console.warn('Error obteniendo usuarios online', e);
                }
            }

            // === DETECCIÓN DE VISIBILIDAD Y CIERRE ===
            function sendOfflineStatus() {
                const storedFirst = normalizeName(localStorage.getItem(STORAGE_KEYS.first) || '');
                const storedLast = normalizeName(localStorage.getItem(STORAGE_KEYS.last) || '');
                if (!storedFirst || !storedLast) return;

                // Usar sendBeacon para enviar antes de cerrar (más fiable que fetch)
                const payload = JSON.stringify({
                    type: 'status',
                    nombre: storedFirst,
                    apellido: storedLast,
                    estado: 'OFF'
                });
                navigator.sendBeacon(G_SCRIPT_URL, payload);
            }

            function sendOnlineStatus() {
                const storedFirst = normalizeName(localStorage.getItem(STORAGE_KEYS.first) || '');
                const storedLast = normalizeName(localStorage.getItem(STORAGE_KEYS.last) || '');
                if (!storedFirst || !storedLast) return;

                fetch(G_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'status',
                        nombre: storedFirst,
                        apellido: storedLast,
                        estado: 'En linea'
                    })
                }).catch(() => { });
            }

            // Solo detectar cuando la pestaña se oculta/muestra (más estable)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    sendOfflineStatus();
                } else {
                    sendOnlineStatus();
                }
            });

            // Detectar cierre de página
            window.addEventListener('beforeunload', () => {
                sendOfflineStatus();
            });
        })();

    </script>
</body>

</html>
