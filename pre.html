<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Crucigramas - Login</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            transition: transform 0.3s ease;
        }

        .container:hover {
            transform: translateY(-5px);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #333;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            font-size: 1rem;
        }

        .login-form {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-group input:focus {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group label {
            position: absolute;
            top: 15px;
            left: 20px;
            color: #666;
            font-size: 16px;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .form-group input:focus + label,
        .form-group input:not(:placeholder-shown) + label {
            top: -10px;
            left: 15px;
            font-size: 12px;
            color: #667eea;
            background: white;
            padding: 0 5px;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .game-sections {
            display: none;
            text-align: center;
        }

        .sections-title {
            color: #333;
            font-size: 2rem;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .sections-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 18px;
            font-weight: 600;
        }

        .section-card:nth-child(2) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .section-card:nth-child(3) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .section-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .logout-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #5a6268;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }

            .logo h1 {
                font-size: 2rem;
            }

            .sections-title {
                font-size: 1.5rem;
            }

            .section-card {
                padding: 20px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 25px 15px;
            }

            .logo h1 {
                font-size: 1.8rem;
            }

            .form-group input {
                padding: 12px 15px;
                font-size: 14px;
            }

            .login-btn {
                padding: 12px;
                font-size: 14px;
            }
        }

        /* Animaciones */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            animation: fadeIn 0.6s ease-out;
        }

        /* Estilos para el overlay del crucigrama */
        .crossword-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: none;
        }

        .crossword-container {
            position: absolute;
            bottom: -100%;
            left: 0;
            top: 0;
            width: 100%;
            height: 100vh;
            background: white;
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: hidden;
            transform: translateY(100%) scale(0.95);
            opacity: 0;
        }

        .crossword-container.show {
            bottom: 0;
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .crossword-iframe {
            width: 100%;
            height: 100vh;
            border: none;
            background: white;
            margin: 0;
            padding: 0;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s ease 0.2s;
            opacity: 0;
        }

        .crossword-container.show .crossword-iframe {
            opacity: 1;
        }
        /* ...existing styles... */

/* Animaci√≥n de shake para el contenedor */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
}

.shake {
    animation: shake 0.6s ease-in-out;
}

/* Animaciones para el mensaje inline */
@keyframes fadeInError {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOutError {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

/* Estilo adicional para campos con error */
.form-group input.error {
    border-color: #f44336 !important;
    background: rgba(244, 67, 54, 0.05) !important;
    box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1) !important;
}


    </style>
</head>
<body>
    <div class="container">
        <!-- Secci√≥n de Login -->
        <div id="loginSection" class="login-form">
            <div class="logo">
                <h1>üß© Crucigramas</h1>
                <p>Desaf√≠a tu mente con nuestros juegos</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" id="username" placeholder=" " required>
                    <label for="username">Nombre de usuario</label>
                </div>
                
                <div class="form-group">
                    <input type="password" id="password" placeholder=" " required>
                    <label for="password">Contrase√±a</label>
                </div>
                
                <button type="submit" class="login-btn">
                    Iniciar Sesi√≥n
                </button>
            </form>
        </div>

        <!-- Secci√≥n de Juegos -->
        <div id="gameSection" class="game-sections">
            <h2 class="sections-title">Selecciona una categor√≠a</h2>
            
            <div class="sections-grid">
                <button class="section-card" onclick="startGame('lexico')">
                    üìö L√©xico
                    <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">
                        Expande tu vocabulario
                    </div>
                </button>
                
                <button class="section-card" onclick="startGame('gramatica')">
                    üìñ Gram√°tica
                    <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">
                        Domina las reglas del idioma
                    </div>
                </button>
                
                <button class="section-card" onclick="startGame('audicion')">
                    üéß Audici√≥n
                    <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">
                        Mejora tu comprensi√≥n auditiva
                    </div>
                </button>
            </div>
            
            <button class="logout-btn" onclick="logout()">
                Cerrar Sesi√≥n
            </button>
        </div>

        <!-- Secci√≥n de Subcategor√≠as de L√©xico -->
        <div id="lexicoSection" class="game-sections">
            <h2 class="sections-title">L√©xico - Categor√≠as</h2>
            
            <div class="sections-grid">
                <button class="section-card" onclick="startSubGame('frutas')">
                    üçé Frutas
                    <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">
                        Aprende nombres de frutas
                    </div>
                </button>
                
                <button class="section-card" onclick="startSubGame('verduras')">
                    ü•ï Verduras
                    <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">
                        Descubre las verduras
                    </div>
                </button>
                
                <button class="section-card" onclick="startSubGame('animales')">
                    üê∂ Animales
                    <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">
                        Conoce el reino animal
                    </div>
                </button>
                
                <button class="section-card" onclick="startSubGame('colores')">
                    üé® Colores
                    <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">
                        Explora los colores
                    </div>
                </button>
            </div>
            
            <button class="logout-btn" onclick="goBackToCategories()" style="margin-right: 10px;">
                ‚Üê Volver
            </button>
            <button class="logout-btn" onclick="logout()">
                Cerrar Sesi√≥n
            </button>
        </div>
    </div>

    <!-- Overlay del Crucigrama -->
    <div id="crosswordOverlay" class="crossword-overlay">
        <div id="crosswordContainer" class="crossword-container">
            <iframe id="crosswordIframe" class="crossword-iframe" src=""></iframe>
        </div>
    </div>

    <script>


// Listener para cerrar el crucigrama desde el iframe (mensaje CLOSE_GAME_IFRAME)
window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'CLOSE_GAME_IFRAME') {
        closeCrossword();
    }
});



        // Variables globales para el tracking
        let currentUser = {
            username: '',
            password: '',
            orderNumber: null,
            currentSection: 'login'
        };

        // URL del Google Apps Script para registro de datos
        const LOGGING_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxiYr-m5cmUGh-KNZvszv5AeZsLyss33rr5GT4FrsN6MOtSHUToD1iQpoNv0eTgnA8nhw/exec';

        // Manejo del formulario de login
  document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    // Validaci√≥n simple
    if (username.trim() !== '' && password.trim() !== '') {
        // Guardar datos del usuario
        currentUser.username = username;
        currentUser.password = password;
        
        // GUARDAR NOMBRE EN LOCALSTORAGE INMEDIATAMENTE
        localStorage.setItem('crosswordUsername', username);
        
        // Mostrar mensaje de carga
        showMessage('Conectando...', 'info');
        
        // Registrar login del usuario
        registerUserLogin(username, password).then(orderNumber => {
            currentUser.orderNumber = orderNumber;
            
            // GUARDAR SESI√ìN COMPLETA
            saveSession();
            
            // Ocultar login y mostrar secciones de juego
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            
            // Efecto de transici√≥n suave
            document.getElementById('gameSection').style.animation = 'fadeIn 0.6s ease-out';
        }).catch(error => {
            console.error('Error al registrar usuario:', error);
            showMessage('Usuario existente.', 'error');
            // Eliminar nombre del localStorage en caso de error
            localStorage.removeItem('crosswordUsername');
        });
    } else {
        showMessage('Por favor, completa todos los campos', 'error');
    }
});
// ...existing code...

// Variable global para controlar usuarios localmente con persistencia
// ...existing code...

// Variable global para controlar usuarios localmente con persistencia
let localUserDatabase = {
    users: new Map(),
    
    // Cargar usuarios del localStorage
    load() {
        try {
            const stored = localStorage.getItem('crosswordUsers');
            if (stored) {
                const data = JSON.parse(stored);
                this.users = new Map(data);
            }
        } catch (e) {
            console.error('Error cargando usuarios locales:', e);
        }
    },
    
    // Guardar usuarios en localStorage
    save() {
        try {
            const data = Array.from(this.users.entries());
            localStorage.setItem('crosswordUsers', JSON.stringify(data));
        } catch (e) {
            console.error('Error guardando usuarios locales:', e);
        }
    },
    
    // Verificar si un usuario existe
    userExists(username) {
        return this.users.has(username);
    },
    
    // Verificar credenciales exactas
    validateUser(username, password) {
        const storedPassword = this.users.get(username);
        return storedPassword === password;
    },
    
    // Agregar nuevo usuario
    addUser(username, password) {
        this.users.set(username, password);
        this.save();
    }
};

// Cargar base de datos local
localUserDatabase.load();



// Funci√≥n principal de login con validaci√≥n completa
async function registerUserLogin(username, password) {
    try {
        // PASO 1: Intentar verificar contra el servidor primero
        try {
            const response = await fetch(LOGGING_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'registerLogin',
                    username: username,
                    password: password,
                    timestamp: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Respuesta del servidor:', data); // Para debug
            
            // Verificar si la respuesta indica √©xito Y login v√°lido
            if (data.success && data.validLogin) {
                // Login exitoso en servidor
                localUserDatabase.addUser(username, password); // Sincronizar con local
                
                if (data.userExists) {
                    showMessage(`¬°Bienvenido de vuelta ${username}!`, 'success');
                } else {
                    showMessage(`¬°Cuenta creada exitosamente ${username}!`, 'success');
                }
                return data.orderNumber;
                
            } else if (data.userExists && !data.validLogin) {
                // Usuario existe en servidor pero con contrase√±a diferente - RECHAZAR
                showMessage('Usuario existente', 'error');
                document.getElementById('username').value = '';
                document.getElementById('username').focus();
                throw new Error('Usuario existente');
                
            } else if (!data.success) {
                // Error general del servidor
                showMessage('Usuario existente', 'error');
                throw new Error('Usuario existente');
            }
            
        } catch (corsError) {
            console.log('Error CORS o servidor no disponible:', corsError.message);
            
            // Verificar si es un error de validaci√≥n ya manejado
            if (corsError.message.includes('Usuario existente')) {
                throw corsError;
            }
            
            // PASO 2: Fallback a validaci√≥n local si el servidor no responde
            if (localUserDatabase.userExists(username)) {
                if (localUserDatabase.validateUser(username, password)) {
                    // Usuario existente con credenciales correctas en local - PERMITIR LOGIN
                    showMessage(`¬°Bienvenido de vuelta ${username}!`, 'success');
                    sendToServerSilently(username, password);
                    return Date.now();
                } else {
                    // Usuario existe en local pero con contrase√±a incorrecta - RECHAZAR
                    showMessage('Usuario existente', 'error');
                    document.getElementById('username').value = '';
                    document.getElementById('username').focus();
                    throw new Error('Usuario existente');
                }
            }
            
            // Usuario nuevo en modo local
            localUserDatabase.addUser(username, password);
            sendToServerSilently(username, password);
            showMessage(`¬°Cuenta creada exitosamente ${username}!`, 'success');
            return Date.now();
        }
        
    } catch (error) {
        console.error('Error completo:', error);
        
        // Mostrar siempre "Usuario existente" para cualquier error relacionado con usuarios duplicados
        if (error.message.includes('Usuario existente')) {
            // El mensaje ya se mostr√≥ arriba, no hacer nada m√°s
            throw error;
        } else {
            // Para cualquier otro error, tambi√©n mostrar "Usuario existente"
            showMessage('Usuario existente', 'error');
            throw error;
        }
    }
}





// Funci√≥n mejorada para sincronizar con servidor
async function syncWithServer() {
    try {
        // Obtener lista de usuarios del servidor
        const response = await fetch(LOGGING_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'getAllUsers'
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.users) {
            // Sincronizar usuarios del servidor con base local
            data.users.forEach(user => {
                localUserDatabase.addUser(user.username, user.password);
            });
            console.log('Sincronizaci√≥n con servidor completada');
        }
        
    } catch (error) {
        console.log('No se pudo sincronizar con servidor:', error.message);
    }
}

// Funci√≥n auxiliar para enviar datos al servidor sin esperar respuesta
async function sendToServerSilently(username, password) {
    try {
        await fetch(LOGGING_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'registerLogin',
                username: username,
                password: password,
                timestamp: new Date().toISOString()
            })
        });
        console.log('Datos enviados al servidor silenciosamente');
    } catch (error) {
        console.error('Error enviando datos al servidor:', error);
    }
}

// Funci√≥n de debug para ver qu√© responde el servidor
async function testServerResponse(username, password) {
    try {
        const response = await fetch(LOGGING_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'registerLogin',
                username: username,
                password: password,
                timestamp: new Date().toISOString()
            })
        });
        
        const data = await response.json();
        console.log('=== RESPUESTA COMPLETA DEL SERVIDOR ===');
        console.log('Response status:', response.status);
        console.log('Data completo:', data);
        console.log('success:', data.success);
        console.log('userExists:', data.userExists);
        console.log('validLogin:', data.validLogin);
        console.log('message:', data.message);
        console.log('error:', data.error);
        console.log('======================================');
        
    } catch (error) {
        console.error('Error en test:', error);
    }
}

// Inicializar sincronizaci√≥n al cargar la p√°gina
syncWithServer();

// Funci√≥n para limpiar base de datos local (opcional - para testing)
function clearLocalDatabase() {
    localUserDatabase.users.clear();
    localUserDatabase.save();
    console.log('Base de datos local limpiada');
}

// Funci√≥n de logout modificada para limpiar sesi√≥n pero mantener usuarios
function logout() {
    // Limpiar datos del usuario actual
    currentUser = {
        username: '',
        password: '',
        orderNumber: null,
        currentSection: 'login'
    };
    
    // LIMPIAR SESI√ìN Y NOMBRE DE LOCALSTORAGE
    clearSession();
    localStorage.removeItem('crosswordUsername');
    
    document.getElementById('gameSection').style.display = 'none';
    document.getElementById('lexicoSection').style.display = 'none';
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('loginSection').style.animation = 'fadeIn 0.6s ease-out';
    
    // Limpiar campos
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    
    showMessage('Sesi√≥n cerrada correctamente', 'info');
}

function getSavedUsername() {
    return localStorage.getItem('crosswordUsername');
}

// Funci√≥n para verificar si hay un usuario logueado
function isUserLoggedIn() {
    return localStorage.getItem('crosswordUsername') !== null;
}

// Funci√≥n mejorada para sincronizar con servidor
async function syncWithServer() {
    try {
        // Obtener lista de usuarios del servidor
        const response = await fetch(LOGGING_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'getAllUsers'
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.users) {
            // Sincronizar usuarios del servidor con base local
            data.users.forEach(user => {
                localUserDatabase.addUser(user.username, user.password);
            });
            console.log('Sincronizaci√≥n con servidor completada');
        }
        
    } catch (error) {
        console.log('No se pudo sincronizar con servidor:', error.message);
    }
}

// Funci√≥n auxiliar para enviar datos al servidor sin esperar respuesta
async function sendToServerSilently(username, password) {
    try {
        await fetch(LOGGING_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'registerLogin',
                username: username,
                password: password,
                timestamp: new Date().toISOString()
            })
        });
        console.log('Datos enviados al servidor silenciosamente');
    } catch (error) {
        console.error('Error enviando datos al servidor:', error);
    }
}

// Cargar base de datos local y sincronizar al iniciar
localUserDatabase.load();
syncWithServer(); // Intentar sincronizar con servidor al cargar la p√°gina



// Funci√≥n para limpiar base de datos local (opcional - para testing)
function clearLocalDatabase() {
    localUserDatabase.users.clear();
    localUserDatabase.save();
    console.log('Base de datos local limpiada');
}

// Funci√≥n de logout modificada para limpiar sesi√≥n pero mantener usuarios
function logout() {
    // Limpiar datos del usuario actual
    currentUser = {
        username: '',
        password: '',
        orderNumber: null
    };
    
    document.getElementById('gameSection').style.display = 'none';
    document.getElementById('lexicoSection').style.display = 'none';
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('loginSection').style.animation = 'fadeIn 0.6s ease-out';
    
    // Limpiar campos
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
}

// Debug: funci√≥n para ver usuarios locales (temporal)
function showLocalUsers() {
    console.log('Usuarios locales:', Array.from(localUserDatabase.users.entries()));
}

// ...existing code...


// ...existing code...

// Nueva funci√≥n para mostrar mensajes al usuario
function showMessage(message, type = 'info') {
    // Si es un error de usuario existente, tambi√©n mostrar debajo del formulario y hacer shake
    if (message.includes('Usuario existente')) {
        showInlineError(message);
        shakeLoginForm();
    }
    
    // Crear elemento de mensaje
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-popup ${type}`;
    messageDiv.textContent = message;
    
    // Estilos para el mensaje
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
    `;
    
    // Colores seg√∫n el tipo
    if (type === 'success') {
        messageDiv.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
    } else if (type === 'info') {
        messageDiv.style.background = 'linear-gradient(135deg, #2196F3, #1976D2)';
    } else if (type === 'error') {
        messageDiv.style.background = 'linear-gradient(135deg, #f44336, #d32f2f)';
    }
    
    // A√±adir al DOM
    document.body.appendChild(messageDiv);
    
    // Animar entrada
    setTimeout(() => {
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateX(0)';
    }, 100);
    
    // Eliminar despu√©s de 4 segundos
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 4000);
}

// ...existing code...

// Funci√≥n mejorada para mostrar error inline debajo del formulario
function showInlineError(message) {
    // Eliminar mensaje de error previo si existe
    const existingError = document.getElementById('inline-error');
    if (existingError) {
        existingError.remove();
    }
    
    // A√±adir clase de error a los campos
    const usernameField = document.getElementById('username');
    const passwordField = document.getElementById('password');
    usernameField.classList.add('error');
    passwordField.classList.add('error');
    
    // Eliminar clase de error despu√©s de 3 segundos
    setTimeout(() => {
        usernameField.classList.remove('error');
        passwordField.classList.remove('error');
    }, 3000);
    
    // Crear nuevo mensaje de error
    const errorDiv = document.createElement('div');
    errorDiv.id = 'inline-error';
    errorDiv.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <span style="color: #f44336; font-size: 18px;">‚ö†Ô∏è</span>
            <span>${message}</span>
        </div>
    `;
    errorDiv.style.cssText = `
        color: #f44336;
        background: rgba(244, 67, 54, 0.1);
        border: 1px solid rgba(244, 67, 54, 0.3);
        padding: 12px 15px;
        border-radius: 8px;
        margin-top: 15px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        animation: fadeInError 0.3s ease-out;
    `;
    
    // Insertar despu√©s del bot√≥n de login
    const loginBtn = document.querySelector('.login-btn');
    loginBtn.parentNode.insertBefore(errorDiv, loginBtn.nextSibling);
    
    // Eliminar despu√©s de 5 segundos
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.style.animation = 'fadeOutError 0.3s ease-out';
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 300);
        }
    }, 5000);
}

// ...existing code...
// Funci√≥n para hacer shake al formulario de login
function shakeLoginForm() {
    const container = document.querySelector('.container');
    container.classList.add('shake');
    
    // Eliminar la clase despu√©s de la animaci√≥n
    setTimeout(() => {
        container.classList.remove('shake');
    }, 600);
}

// ...existing code...

        // Funci√≥n para registrar acceso a tema
        async function registerTopicAccess(topic) {
            if (!currentUser.orderNumber) {
                console.error('No hay usuario logueado');
                return;
            }
            
            try {
                await fetch(LOGGING_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'registerTopic',
                        orderNumber: currentUser.orderNumber,
                        username: currentUser.username,
                        password: currentUser.password,
                        topic: topic,
                        timestamp: new Date().toISOString()
                    })
                });
                
                console.log(`Registrado acceso al tema: ${topic}`);
                
            } catch (error) {
                console.error('Error al registrar tema:', error);
            }
        }

        // Funci√≥n para iniciar juego (CORREGIDA)
function startGame(category) {
    if (category === 'lexico') {
        // CAMBIAR A SECCI√ìN L√âXICO Y GUARDAR
        currentUser.currentSection = 'lexico';
        saveSession();
        
        document.getElementById('gameSection').style.display = 'none';
        document.getElementById('lexicoSection').style.display = 'block';
        document.getElementById('lexicoSection').style.animation = 'fadeIn 0.6s ease-out';
    } else {
        alert(`¬°Iniciando juego de ${category.toUpperCase()}!`);
    }
}

// Funci√≥n para volver a las categor√≠as principales (CORREGIDA)
function goBackToCategories() {
    // CAMBIAR A SECCI√ìN PRINCIPAL Y GUARDAR
    currentUser.currentSection = 'game';
    saveSession();
    
    document.getElementById('lexicoSection').style.display = 'none';
    document.getElementById('gameSection').style.display = 'block';
    document.getElementById('gameSection').style.animation = 'fadeIn 0.6s ease-out';
}

function prepareUserDataForExternalPage() {
    const username = getSavedUsername() || currentUser.username;
    const userData = {
        username: username,
        orderNumber: currentUser.orderNumber || Date.now(),
        loginTimestamp: new Date().toISOString(),
        sessionId: generateSessionId(),
        source: 'crossword_main_app'
    };
    
    // Guardar con m√∫ltiples claves para m√°xima compatibilidad
    localStorage.setItem('userName', username); // Para tu c√≥digo actual
    localStorage.setItem('crosswordUsername', username); // Clave actual
    localStorage.setItem('externalGameUser', JSON.stringify(userData)); // Datos completos
    localStorage.setItem('currentGameSession', JSON.stringify(userData)); // Sesi√≥n de juego
    
    console.log('Datos preparados para p√°gina externa:', userData);
    return userData;
}

// Funci√≥n para generar ID de sesi√≥n √∫nico
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// ...existing code...
// Funci√≥n para iniciar subcategor√≠as de juego (CORREGIDA)
function startSubGame(subcategory) {
    // Preparar datos de usuario
    const userData = prepareUserDataForExternalPage();

    // ASEGURAR QUE SE MANTENGA EN L√âXICO
    currentUser.currentSection = 'lexico';
    saveSession();

    // Registrar acceso al tema
    registerTopicAccess(subcategory);

    // Usar URLs de GitHub Pages
    let localUrl = '';
    if (subcategory === 'frutas') {
        localUrl = 'https://fawzinoo.github.io/Rep/crucifrutas.html';
    } else if (subcategory === 'verduras') {
        localUrl = 'https://fawzinoo.github.io/Rep/cruci_verduras.html';
    } else if (subcategory === 'animales') {
        localUrl = 'https://fawzinoo.github.io/Rep/cruci_animales.html';
    } else if (subcategory === 'colores') {
        localUrl = 'https://fawzinoo.github.io/Rep/cruci_colores.html';
    } else {
        alert(`¬°Iniciando juego de ${subcategory.toUpperCase()}!`);
        return;
    }

    console.log('Cargando juego desde:', localUrl);

    // Verificar si la URL es accesible
    fetch(localUrl, { method: 'HEAD' })
        .then(response => {
            if (response.ok) {
                console.log(`Archivo encontrado en: ${localUrl}`);
                const urlWithParams = `${localUrl}?username=${encodeURIComponent(userData.username)}&orderNumber=${userData.orderNumber}&sessionId=${userData.sessionId}`;
                openCrossword(urlWithParams, `Crucigrama de ${subcategory.charAt(0).toUpperCase() + subcategory.slice(1)}`);
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        })
        .catch(error => {
            console.error(`Error accediendo a: ${localUrl}`, error);
            showMessage(`Error cargando el juego de ${subcategory}`, 'error');
            
            // Mostrar p√°gina de error con informaci√≥n √∫til
            const tempUrl = `data:text/html,
                <html>
                    <head>
                        <title>Error - Crucigrama de ${subcategory}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                text-align: center;
                                padding: 50px;
                                margin: 0;
                            }
                            .container {
                                background: rgba(255, 255, 255, 0.1);
                                padding: 40px;
                                border-radius: 20px;
                                backdrop-filter: blur(10px);
                            }
                            button {
                                background: #f44336;
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 10px;
                                cursor: pointer;
                                font-size: 16px;
                                margin-top: 20px;
                            }
                            .debug {
                                background: rgba(0,0,0,0.3);
                                padding: 20px;
                                border-radius: 10px;
                                margin: 20px 0;
                                font-family: monospace;
                                font-size: 12px;
                                text-align: left;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1>üö´ Error al cargar el juego</h1>
                            <p>No se pudo acceder al crucigrama de ${subcategory}.</p>
                            <div class="debug">
                                <strong>URL intentada:</strong><br>
                                ${localUrl}<br><br>
                                <strong>Error:</strong> ${error.message}
                            </div>
                            <p>Por favor, verifica que el archivo est√© disponible en GitHub Pages.</p>
                            <button onclick="window.parent.postMessage({type: 'CLOSE_GAME'}, '*')">
                                Volver atr√°s
                            </button>
                        </div>
                    </body>
                </html>`;
            
            openCrossword(tempUrl, `Error - Crucigrama de ${subcategory.charAt(0).toUpperCase() + subcategory.slice(1)}`);
        });
}
// ...existing code...



// ...existing code...
// Funci√≥n para abrir el crucigrama con transici√≥n chula
function openCrossword(url, title) {
    const overlay = document.getElementById('crosswordOverlay');
    const container = document.getElementById('crosswordContainer');
    const iframe = document.getElementById('crosswordIframe');

    // Obtener datos del usuario
    const username = getSavedUsername() || currentUser.username;
    const userOrderNumber = currentUser.orderNumber || Date.now();

    console.log('=== DEBUG: Abriendo crucigrama ===');
    console.log('URL original:', url);
    console.log('Username:', username);
    console.log('OrderNumber:', userOrderNumber);

    // Configurar el contenido del iframe directamente
    iframe.src = url;

    // Mostrar overlay
    overlay.style.display = 'block';

    // Trigger transici√≥n
    setTimeout(() => {
        container.classList.add('show');
    }, 100);

    // Comunicaci√≥n mejorada con el iframe
    iframe.onload = function() {
        console.log('=== DEBUG: Iframe cargado correctamente ===');
        console.log('Iframe src:', iframe.src);

        // Enviar datos v√≠a postMessage despu√©s de un breve delay
        setTimeout(() => {
            const userData = {
                type: 'USER_DATA',
                username: username,
                orderNumber: userOrderNumber,
                timestamp: Date.now(),
                source: 'crossword_login'
            };

            try {
                console.log('Enviando datos al iframe:', userData);
                iframe.contentWindow.postMessage(userData, '*');
            } catch (error) {
                console.log('Error enviando datos al iframe (normal en GitHub Pages):', error);
            }

            // Tambi√©n guardar en localStorage
            localStorage.setItem('externalGameUser', JSON.stringify(userData));
            localStorage.setItem('userName', username);
            console.log('Datos guardados en localStorage');
        }, 1000);
    };

    // Manejar errores de carga
    iframe.onerror = function() {
        console.error('=== ERROR: No se pudo cargar el iframe ===');
        showMessage('Error cargando el juego', 'error');
        setTimeout(() => {
            closeCrossword();
        }, 2000);
    };
}

// Listener mejorado para mensajes desde el iframe
window.addEventListener('message', function(event) {
    console.log('=== DEBUG: Mensaje recibido ===');
    console.log('Origin:', event.origin);
    console.log('Data:', event.data);

    // Verificar origen si es necesario
    if (event.origin && !event.origin.includes('github.io') && !event.origin.includes('localhost')) {
        console.log('Mensaje de origen no confiable ignorado:', event.origin);
        return;
    }

    if (event.data && event.data.type === 'GAME_READY') {
        console.log('=== El juego est√° listo, reenviando datos ===');

        const username = getSavedUsername() || currentUser.username;
        const userData = {
            type: 'USER_DATA',
            username: username,
            orderNumber: currentUser.orderNumber || Date.now(),
            timestamp: Date.now(),
            source: 'crossword_login'
        };

        try {
            event.source.postMessage(userData, event.origin);
            console.log('Datos reenviados exitosamente');
        } catch (error) {
            console.error('Error reenviando datos:', error);
        }
    }

    if (event.data && event.data.type === 'CLOSE_GAME') {
        console.log('=== Solicitud de cierre recibida ===');
        closeCrossword();
    }

    // Debug: loggear todos los mensajes para entender qu√© est√° pasando
    if (event.data) {
        console.log('Tipo de mensaje:', event.data.type);
        console.log('Contenido completo:', event.data);
    }
});

// Funci√≥n mejorada para cerrar el crucigrama
function closeCrossword() {
    console.log('=== DEBUG: Cerrando crucigrama ===');
    
    const overlay = document.getElementById('crosswordOverlay');
    const container = document.getElementById('crosswordContainer');
    const iframe = document.getElementById('crosswordIframe');

    // Ocultar con transici√≥n suave
    container.classList.remove('show');

    // Ocultar overlay despu√©s de la transici√≥n
    setTimeout(() => {
        overlay.style.display = 'none';
        iframe.src = ''; // Limpiar iframe
        console.log('Iframe limpiado');
    }, 600);

    // Mostrar la secci√≥n de subcategor√≠as (l√©xico)
    currentUser.currentSection = 'lexico';
    saveSession();

    // Ocultar todas las secciones primero
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('gameSection').style.display = 'none';
    document.getElementById('lexicoSection').style.display = 'none';

    // Mostrar solo la de l√©xico (subcategor√≠as)
    document.getElementById('lexicoSection').style.display = 'block';
    document.getElementById('lexicoSection').style.animation = 'fadeIn 0.6s ease-out';
    
    console.log('Volviendo a subcategor√≠as de l√©xico');
}
// ...existing code...

// Funci√≥n para volver a las categor√≠as principales (modificada)
function goBackToCategories() {
    // Cambiar a secci√≥n principal
    currentUser.currentSection = 'game';
    saveSession();
    
    document.getElementById('lexicoSection').style.display = 'none';
    document.getElementById('gameSection').style.display = 'block';
    document.getElementById('gameSection').style.animation = 'fadeIn 0.6s ease-out';
}


// Funci√≥n para guardar sesi√≥n
function saveSession() {
    try {
        localStorage.setItem('crosswordSession', JSON.stringify(currentUser));
        console.log('Sesi√≥n guardada para:', currentUser.username, 'Secci√≥n:', currentUser.currentSection);
    } catch (error) {
        console.error('Error guardando sesi√≥n:', error);
    }
}

// Funci√≥n para limpiar sesi√≥n
function clearSession() {
    try {
        localStorage.removeItem('crosswordSession');
        console.log('Sesi√≥n limpiada');
    } catch (error) {
        console.error('Error limpiando sesi√≥n:', error);
    }
}

// Cargar sesi√≥n al inicializar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    if (!loadSession()) {
        // Si no hay sesi√≥n guardada, mostrar login
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('gameSection').style.display = 'none';
        document.getElementById('lexicoSection').style.display = 'none';
    }
});





        // Efecto de part√≠culas en el fondo (opcional)
        function createParticles() {
            const particles = document.createElement('div');
            particles.className = 'particles';
            document.body.appendChild(particles);
            
            for (let i = 0; i < 100; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + 'vw';
                particle.style.animationDuration = Math.random() * 2 + 3 + 's';
                particles.appendChild(particle);
            }
        }

        function loadSession() {
    try {
        const savedSession = localStorage.getItem('crosswordSession');
        if (savedSession) {
            const session = JSON.parse(savedSession);
            currentUser = session;
            
            // Restaurar el estado de la interfaz seg√∫n la secci√≥n guardada
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'none';
            document.getElementById('lexicoSection').style.display = 'none';
            
            if (currentUser.currentSection === 'game') {
                document.getElementById('gameSection').style.display = 'block';
            } else if (currentUser.currentSection === 'lexico') {
                document.getElementById('lexicoSection').style.display = 'block';
            } else {
                // Por defecto, mostrar game si el usuario est√° logueado
                document.getElementById('gameSection').style.display = 'block';
                currentUser.currentSection = 'game';
            }
            
            console.log('Sesi√≥n restaurada para:', currentUser.username, 'Secci√≥n:', currentUser.currentSection);
            return true;
        }
    } catch (error) {
        console.error('Error cargando sesi√≥n:', error);
    }
    return false;
}
        createParticles();
    </script>

    <style>
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .particle {
            position: absolute;
            bottom: 100%;
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }
    </style>
</body>
</html>
