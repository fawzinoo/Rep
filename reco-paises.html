<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Países del mundo</title>
    <style>
        /* Estilos de la barra superior */
        .top-status-bar {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto 5px auto;
            gap: 2px;
            position: relative;
            z-index: 10;
        }

        .pill {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 1.0em;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            background: #fff;
            min-width: 60px;
            justify-content: center;
            letter-spacing: 0.3px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .back-arrow {
            background: #fff;
            color: #333;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            gap: 8px;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .back-arrow:hover {
            background-color: #f5f5f5;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .back-arrow i {
            color: #333;
        }        .pill-faltan {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: #fff;
            box-shadow: 0 2px 6px rgba(255,107,53,0.15);
            gap: 8px;
            border: none;
        }

        .pill-correctas {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: #fff;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.15);
            gap: 8px;
            border: none;
        }

        .pill-incorrectas {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.15);
            gap: 8px;
            border: none;
        }

        .pill-progreso {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: #fff;
            box-shadow: 0 2px 6px rgba(78,205,196,0.15);
            font-weight: 600;
            font-size: 1.0em;
            min-width: 60px;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
        }

        .pill-progreso:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(78,205,196,0.2);
        }

        /* Estilos básicos */
        body, html {
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #505255, #00020a);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        #flashcard-container-wrapper {
            position: relative;
            width: calc(100% - 20px);
            max-width: 600px;
        }
        #flashcard-container {
            width: 100%;
            height: 500px;
            max-height: 500px;
            perspective: 1000px; /* Para el efecto 3D */
            border-radius: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
            background: linear-gradient(to right, #1f3658, #3558e3);
            border: 3px solid #aab0b4;
            margin: 0;
        }
        .flashcard, .results-card {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.4, 0.2, 0.2, 1);
            border-radius: 15px;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .flashcard.is-visible { display: flex; }
        
        /* Parte frontal y trasera de la tarjeta */
        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* Oculta la cara trasera al girar */
            border-radius: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
    
        .card-back {
            transform: rotateY(180deg); /* Gira la parte trasera */
        }
    
        /* Estilo de la parte frontal */
        .front img, .back img { width: 100%; height: 100%; }
    
        /* Estilo de la parte trasera */
        .back {
    width: 100%;
    background: linear-gradient(to bottom, rgba(73, 115, 189, 0.95), rgba(14, 40, 92, 0.9)); /* Fondo azul oscuro */
    color: #ffffff; /* Color del texto */
    transform: rotateY(180deg); /* Rotación para el efecto */
    padding: 20px; /* Margen interno */
    text-align: center; /* Centrado horizontal */
    font-size: 3rem; /* Tamaño del texto */
    font-family: 'Playfair Display', serif; /* Fuente elegante */
    border-radius: 10px; /* Bordes redondeados */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Sombra más pronunciada */
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); /* Sombra del texto más fuerte */
    display: flex; /* Flexbox para el centrado */
    justify-content: center; /* Centrar horizontalmente */
    align-items: center; /* Centrar verticalmente */
    flex-direction: column; /* Asegura que el texto fluya en columnas */
    height: 100%; /* Usa toda la altura disponible */
    max-width: 100%; /* Limita el ancho máximo */
    margin: 0 auto; /* Centra dentro del contenedor */
    line-height: 1.4; /* Espaciado entre líneas */
}

        /* Ocultar texto cuando está en modo escucha */
        .back.hidden-text {
            color: transparent;
            text-shadow: none;
        }

        /* Indicador de escucha de voz */
        .listening-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 1.5rem;
            text-align: center;
            animation: pulse 1s infinite;
            z-index: 10;
        }

        @keyframes pulse {
            0% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
            100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
        }

        /* Contador moderno y elegante */
        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 25px;
        }

        .countdown-number {
            font-size: 8rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
            animation: countdownPulse 1s ease-in-out;
            z-index: 1001;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .countdown-circle {
            position: absolute;
            width: 200px;
            height: 200px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: countdownRotate 1s linear;
        }

        @keyframes countdownRotate {
            0% { transform: rotate(0deg) scale(0.8); border-color: rgba(255, 255, 255, 0.3); }
            50% { transform: rotate(180deg) scale(1.1); border-color: rgba(255, 255, 255, 0.8); }
            100% { transform: rotate(360deg) scale(1); border-color: rgba(255, 255, 255, 0.5); }
        }

.back::before, .back::after {
    content: '';
    position: absolute;
    width: 150px; /* Ajusta el tamaño de la forma */
    height: 150px; /* Ajusta el tamaño de la forma */
    background: rgba(255, 255, 255, 0.3); /* Círculos más claros y visibles */
    border-radius: 50%; /* Forma circular */
    z-index: 0; /* Coloca detrás del texto */
}

.back::before {
    top: -30px; /* Ajusta la posición */
    left: -30px; /* Ajusta la posición */
}

.back::after {
    bottom: -30px; /* Ajusta la posición */
    right: -30px; /* Ajusta la posición */
}

    
        /* El efecto de voltear */
        .flashcard.flipped {
            transform: rotateY(180deg); /* Al hacer clic, se voltea la tarjeta */
        }
    
/* Contenedor de botones */
.button-container {
    width: 100%;
    max-width: 370px;
    display: flex;
    justify-content: space-evenly; /* Espacio uniforme entre todos los botones */
    align-items: center;
    padding: 10px 0px;
    background-color: #ffffff;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    margin-top: 10px;
}



/* Botones individuales */
.button {
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 50px;
    background-color: #3498db;
    color: #fff;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
     
        .button:hover { transform: translateY(-3px); }





.overlay-text {
    position: absolute;
    z-index: 1; /* Colocar por encima del contenido */
    color: white; /* Color del texto */
    font-size: 2rem; /* Tamaño del texto */
    font-weight: bold; /* Texto en negrita */
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); /* Sombra del texto */
    text-align: left; /* Alineación a la izquierda */
    pointer-events: none; /* No interferir con los clics */
    margin: 5%; /* Margen relativo */
    line-height: 1.5; /* Espaciado entre líneas */
    top: 40%; /* Posición específica desde arriba */
    left: 0%; /* Posición específica desde la izquierda */
}

/* Estilos para .overlay-text1 */
.overlay-text1 {
    position: absolute;
    top: 5px;
    z-index: 1;
    color: rgb(185, 232, 203); /* Color específico */
    font-size: 2rem; /* Tamaño del texto */
    font-weight: bold; /* Texto en negrita */
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); /* Sombra del texto */
    text-align: center; /* Centrado */
    pointer-events: none; /* No interferir con clics */
    display: inline-block; /* Comportamiento inline */
    animation: pulse 1.5s infinite; /* Animación pulsante */
}

/* Estilos para .overlay-text2 */
.overlay-text2 {
    position: absolute;
    z-index: 1;
    color: white; /* Color del texto */
    font-size: 2rem; /* Tamaño del texto */
    font-weight: bold; /* Negrita */
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); /* Sombra del texto */
    text-align: left; /* Alineación a la izquierda */
    pointer-events: none; /* No interferir con clics */
    margin: 30px; /* Márgenes específicos */
    top: 40%; /* Posición específica desde arriba */
}

@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes moveLeftToRight {
  0% {
    transform: translateX(0); /* Posición inicial */
  }
  50% {
    transform: translateX(10px); /* Mueve hacia la derecha */
  }
  100% {
    transform: translateX(0); /* Vuelve a la posición original */
  }
}



.back-arrow {
    background: #fff;
    color: #333;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    gap: 8px;
    border: 1px solid rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.back-arrow:hover {
    background-color: #f5f5f5;
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.back-arrow i {
    color: #333;
}

.intentos-back {
    position: absolute;
    top: 18px;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 1.3rem;
    font-weight: bold;
    color: #ffd700;
    z-index: 2;
    pointer-events: none;
}
    </style>
 
</head>
<body>

<div class="top-status-bar">

    <div class="pill back-arrow" onclick="goBack()">
        <span><i class="fas fa-arrow-left"></i></span>
    </div>
  <div class="pill pill-faltan">
    <span>T: <span id="total-cards"></span></span>
  </div>
    <div class="pill pill-correctas">
        <span><i class="fas fa-check"></i> <span id="correctas-count">0</span></span>
    </div>
    <div class="pill pill-incorrectas">
        <span><i class="fas fa-times"></i> <span id="incorrectas-count">0</span></span>
    </div>
</div>


    <div id="flashcard-container-wrapper">

<!--------------------------------------------------------------------->

<div id="flashcard-container">
       <div class="flashcard">
        <div class="front">                 
            <img src="https://flagcdn.com/w640/es.png" alt="España" loading="lazy">
        </div>
        <div class="back">España</div>
    </div>

    <!-- 2. Marruecos -->
    <div class="flashcard">
        <div class="front">
            <img src="https://flagcdn.com/w640/ma.png" alt="Marruecos" loading="lazy">
        </div>
        <div class="back">Marruecos</div>
    </div>

    <!-- 3. México -->
    <div class="flashcard">
        <div class="front">
            <img src="https://flagcdn.com/w640/mx.png" alt="México" loading="lazy">
        </div>
        <div class="back">México</div>
    </div>

    <!-- 4. Argentina -->
    <div class="flashcard">
        <div class="front">
            <img src="https://flagcdn.com/w640/ar.png" alt="Argentina" loading="lazy">
        </div>
        <div class="back">Argentina</div>
    </div>

    <!-- 5. Colombia -->
    <div class="flashcard">
        <div class="front">
            <img src="https://flagcdn.com/w640/co.png" alt="Colombia" loading="lazy">
        </div>
        <div class="back">Colombia</div>
    </div>

    <!-- 6. Perú -->
    <div class="flashcard">
        <div class="front">
            <img src="https://flagcdn.com/w640/pe.png" alt="Perú" loading="lazy">
        </div>
        <div class="back">Perú</div>
    </div>

    <!-- 7. Chile -->
    <div class="flashcard">
        <div class="front">
            <img src="https://flagcdn.com/w640/cl.png" alt="Chile" loading="lazy">
        </div>
        <div class="back">Chile</div>
    </div>

    <!-- 8. Venezuela -->
    <div class="flashcard">
        <div class="front">
            <img src="https://flagcdn.com/w640/ve.png" alt="Venezuela" loading="lazy">
        </div>
        <div class="back">Venezuela</div>
    </div>













        </div>
    </div>
    <audio id="soundResetButton" src="https://fawzinoo.github.io/audios/bellding-254774.mp3" preload="auto"></audio>
    <audio id="shuffleSound" src="https://fawzinoo.github.io/audios/click-124467.mp3" preload="auto"></audio>

    <div class="button-container">
        <button class="button" id="reset-button" onclick="location.reload()">Reiniciar</button>
        <button class="button" id="shuffle-button" style="background-color: #9b59b6;">
            <i class="fas fa-random"></i> Mezclar
        </button>
    </div>
    

    <!-- Análisis de audio para verificación fonética -->
    <script src="https://unpkg.com/meyda/dist/web/meyda.min.js"></script>

    <!-- Agregar la librería de confeti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <script>
function goBack() {
    // Puedes personalizar esta función según lo que necesites
    if (document.referrer) {
        window.history.back(); // Regresa a la página anterior
    } else {
        // Si no hay página anterior, puedes redirigir a una página específica
        window.location.href = 'https://fawzinoo.github.io/Rep/Vocabulario.html'; // Cambia por la URL que necesites
    }
}

// --- NUEVO SISTEMA DE RECONOCIMIENTO DE VOZ (CLIENTE) ---

let mediaRecorder;
let audioChunks = [];
let isRecording = false;

// Sistema de tarjetas completadas
let completedCards = new Set();
let correctCount = 0;
let incorrectCount = 0;
let currentCardIndex = 0;
let voiceAttempts = 0; // Contador para los intentos de voz
let canFlipBack = true;

// Función para normalizar el texto: quitar acentos, puntuación y a minúsculas.
function normalizeText(text) {
    if (!text) return "";
    return text.trim();
}


function startVoiceRecognition(targetWord, backElement) {
    // Web Speech API (reconocimiento de voz del navegador)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert("Tu navegador no soporta reconocimiento de voz.");
        return;
    }
    const recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    showListeningIndicator(backElement, "Grabando...");

    recognition.onresult = function(event) {
        const spokenWord = event.results[0][0].transcript;
        handleVoiceResult(spokenWord, targetWord, backElement);
    };

    recognition.onerror = function(event) {
        removeListeningIndicator();
        alert("Error de reconocimiento: " + event.error);
    };

    recognition.onend = function() {
        removeListeningIndicator();
    };

    recognition.start();
}

function handleVoiceResult(spokenWord, targetWord, backElement) {
    if (!spokenWord || spokenWord.trim() === "") {
        removeListeningIndicator();
        setBackAttempts(backElement, 2 - voiceAttempts);
        backElement.classList.remove('hidden-text');
        setTimeout(() => {
            const card = backElement.closest('.flashcard');
            if (card && card.classList.contains('flipped')) {
                startVoiceRecognition(targetWord, backElement);
            }
        }, 2000);
        return;
    }
const normalizedSpoken = spokenWord.trim();
const normalizedTarget = targetWord.trim();
    const card = backElement.closest('.flashcard');

    if (palabrasSimilares(normalizedSpoken, normalizedTarget)) {
        correctCount++;
        voiceAttempts = 0;
        canFlipBack = true; 
        playSuccessSound();

        // Mostrar contador y nombre del país debajo SOLO si acierta
        backElement.innerHTML = '';
        setBackAttempts(backElement, 2);
        const nombrePais = document.createElement('div');
        nombrePais.style.marginTop = '40px';
        nombrePais.textContent = targetWord;
        backElement.appendChild(nombrePais);
        backElement.classList.remove('hidden-text');

        setTimeout(() => {
            if (audios[flashcards.indexOf(card)]) {
                stopAllAudios();
                audios[flashcards.indexOf(card)].play().catch(e => {});
                audios[flashcards.indexOf(card)].addEventListener('ended', () => showCountdown(card), { once: true });
            } else {
                showCountdown(card);
            }
        }, 1000);

    } else {
        voiceAttempts++;
        removeListeningIndicator();

        if (voiceAttempts < 2) {
            // Mostrar "Incorrecto" en el primer intento fallido
            setBackAttempts(
                backElement,
                2 - voiceAttempts,
                `<span style="color: #ffdddd; font-size: 2.5rem;">Incorrecto</span>`
            );
            backElement.classList.remove('hidden-text');
            setTimeout(() => {
                setBackAttempts(backElement, 2 - voiceAttempts); // Limpia el mensaje después de 2s
                if (card.classList.contains('flipped')) {
                    startVoiceRecognition(targetWord, backElement);
                }
            }, 2000);

        } else {
            incorrectCount++;
            voiceAttempts = 0;
            canFlipBack = false; 
            setBackAttempts(
                backElement,
                0,
                `<span style="color: #ffdddd; font-size: 2.5rem;">Incorrecto</span>`
            );
            backElement.classList.remove('hidden-text');
            setTimeout(() => {
                setBackAttempts(backElement, 0); // Limpia el mensaje antes de pasar
                goToNextCard();
            }, 1500); 
        }
    }
    updateCounters();
}

function palabrasSimilares(a, b) {
    // Coincidencia exacta
    if (a === b) return true;
    // Permitir 'ni' como equivalente a 'ñ' (pero no 'n')
    const bWithNi = b.replace(/ñ/g, 'ni').replace(/Ñ/g, 'NI');
    if (a === bWithNi) return true;
    return false;
}

function showListeningIndicator(backElement, text = '🎤<br>Habla ahora') {
    removeListeningIndicator();
    const indicator = document.createElement('div');
    indicator.className = 'listening-indicator';
    indicator.innerHTML = text;
    backElement.appendChild(indicator);
}

// --- FIN DEL NUEVO SISTEMA DE VOZ ---


function removeListeningIndicator() {
    document.querySelectorAll('.listening-indicator').forEach(el => el.remove());
}

function playSuccessSound() {
    const successAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUYrTp66hVFApGn+DyvmwhBSuBzvLZiTUJGmmm6eSnVBQKRZ/g8r5wIQUvgM/z1oUzByt2xvLaizsIHGjA+N2cQQ');
    successAudio.volume = 0.3;
    successAudio.play().catch(() => {});
}

function showCountdown(card) {
    const container = document.getElementById('flashcard-container-wrapper');
    const overlay = document.createElement('div');
    overlay.className = 'countdown-overlay';
    
    const circle = document.createElement('div');
    circle.className = 'countdown-circle';
    
    const number = document.createElement('div');
    number.className = 'countdown-number';
    
    overlay.appendChild(circle);
    overlay.appendChild(number);
    container.appendChild(overlay);
    
    let count = 5;
    
    function updateCounter() {
        number.textContent = count;
        number.style.animation = 'none';
        circle.style.animation = 'none';
        
        void number.offsetWidth;
        void circle.offsetWidth;
        
        number.style.animation = 'countdownPulse 1s ease-in-out';
        circle.style.animation = 'countdownRotate 1s linear';
        
        if (count > 0) {
            count--;
            setTimeout(updateCounter, 1000);
        } else {
            overlay.remove();
            goToNextCard();
        }
    }
    
    updateCounter();
}

function goToNextCard() {
    const flashcards = Array.from(document.querySelectorAll('.flashcard'));
    completedCards.add(currentCardIndex);
    updateCardCounter();
    
    canFlipBack = true; // NUEVO: Permitir voltear en la nueva tarjeta
    voiceAttempts = 0; // Reiniciar intentos para la nueva tarjeta

    let nextIndex = -1;
    for (let i = 0; i < flashcards.length; i++) {
        if (!completedCards.has(i)) {
            nextIndex = i;
            break;
        }
    }
    
    if (nextIndex !== -1) {
        currentCardIndex = nextIndex;
        showCard(currentCardIndex);
    } else {
        showCompletionMessage();
    }
}

function showCard(index) {
    const flashcards = Array.from(document.querySelectorAll('.flashcard'));
    flashcards.forEach(card => {
        card.classList.remove('is-visible', 'flipped');
    });
    
    if (flashcards[index]) {
        flashcards[index].classList.add('is-visible');
    }
    updateCounters();
}

function updateProgress() {
    const flashcards = Array.from(document.querySelectorAll('.flashcard'));
    const totalCards = flashcards.length;
    const percentage = totalCards > 0 ? Math.round((completedCards.size / totalCards) * 100) : 0;
    const porcentajeDiv = document.getElementById('porcentaje-guardado');
    if (porcentajeDiv) {
        porcentajeDiv.textContent = `${percentage}%`;
    }
}

function updateCounters() {
    document.getElementById('correctas-count').textContent = correctCount;
    document.getElementById('incorrectas-count').textContent = incorrectCount;
    updateCardCounter();
}

function showCompletionMessage() {
    const container = document.getElementById('flashcard-container');
    container.innerHTML = `
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; color: white; text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 20px;">🎉</div>
            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 10px;">¡Felicidades!</div>
            <div style="font-size: 1.5rem;">Has completado todas las tarjetas</div>
        </div>
    `;
}

const baseUrl = 'https://fawzinoo.github.io/audios/';
const audioFiles = [
    'espana.mp3', 'marruecos.mp3', 'mexico.mp3', 'argentina.mp3', 'colombia.mp3',
    'peru.mp3', 'chile.mp3', 'venezuela.mp3', 'ecuador.mp3', 'bolivia.mp3',
    'paraguay.mp3', 'uruguay.mp3', 'guatemala.mp3', 'cuba.mp3', 'republica-dominicana.mp3',
    'Honduras.mp3', 'Nicaragua.mp3', 'costa-rica.mp3', 'panama.mp3', 'el-salvador.mp3',
    'guinea-ecuatorial.mp3', 'Estados-unidos.mp3', 'canada.mp3', 'brazil.mp3', 'francia.mp3',
    'alemania.mp3', 'holanda.mp3', 'belgica.mp3', 'dinamarca.mp3', 'italia.mp3',
    'reino-unido.mp3', 'rusia.mp3', 'china.mp3', 'japon.mp3', 'corea-del-sur.mp3',
    'india.mp3', 'australia.mp3', 'sudafrica.mp3', 'egipto.mp3', 'nigeria.mp3',
    'turquia.mp3', 'arabia-saudi.mp3', 'iran.mp3'
];

const audios = audioFiles.map(file => {
    const audio = new Audio();
    audio.preload = 'none';
    audio.src = baseUrl + file;
    return audio;
});

const flashcards = Array.from(document.querySelectorAll('.flashcard'));

function shuffleCards() {
    stopAllAudios();

    // 1. Obtener los datos de todas las tarjetas.
    const allCardData = flashcards.map((card, index) => ({
        frontImg: card.querySelector('.front img').src,
        frontAlt: card.querySelector('.front img').alt,
        backText: card.querySelector('.front img').alt, // CORRECCIÓN: Usar el 'alt' como fuente fiable.
        audio: audios[index]
    }));

    // 2. Separar los datos de las tarjetas en pendientes y completadas.
    const remainingCardData = [];
    const completedCardData = [];
    allCardData.forEach((data, index) => {
        if (completedCards.has(index)) {
            completedCardData.push(data);
        } else {
            remainingCardData.push(data);
        }
    });

    // 3. Barajar solo las tarjetas pendientes.
    for (let i = remainingCardData.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [remainingCardData[i], remainingCardData[j]] = [remainingCardData[j], remainingCardData[i]];
    }

    // 4. Crear el nuevo mazo: pendientes barajadas primero, luego las completadas.
    const newCardOrder = [...remainingCardData, ...completedCardData];

    // 5. Actualizar el DOM y los audios según el nuevo orden.
    flashcards.forEach((card, index) => {
        const data = newCardOrder[index];
        card.classList.remove('is-visible', 'flipped');
        card.querySelector('.front img').src = data.frontImg;
        card.querySelector('.front img').alt = data.frontAlt;
        // Restaurar el texto original del reverso por si había cambiado a "Incorrecto"
        card.querySelector('.back').innerHTML = data.backText;
        audios[index] = data.audio;
    });

    // 6. Actualizar el estado para reflejar el nuevo orden.
    setTimeout(() => {
        // Las tarjetas completadas ahora están al final del mazo.
        // Sus nuevos índices van desde `remainingCardData.length` hasta el final.
        const newCompletedCards = new Set();
        for (let i = 0; i < completedCardData.length; i++) {
            newCompletedCards.add(remainingCardData.length + i);
        }
        
        completedCards = newCompletedCards; // Reemplazar el set antiguo por el nuevo.
        currentCardIndex = 0; // Empezar desde la primera tarjeta pendiente.
        
        showCard(currentCardIndex);
        updateCounters(); // Actualizar los contadores en la UI sin reiniciarlos.
    }, 10);
}


flashcards.forEach((card) => {
    card.addEventListener('click', () => {
        const backElement = card.querySelector('.back');
        // Si la tarjeta está mostrando el reverso (flipped)
        if (card.classList.contains('flipped')) {
            // Volteo de back a front: NO detiene grabación, solo voltea y actualiza contador
            card.classList.remove('flipped');
            removeListeningIndicator();
            stopAllAudios();
            backElement.innerHTML = '';
            setBackAttempts(backElement, 2 - voiceAttempts);
        } else {
            // Volteo de front a back: inicia grabación solo si quedan intentos
            if (voiceAttempts < 2) {
    card.classList.add('flipped');
    backElement.classList.add('hidden-text');
    backElement.innerHTML = '';
    setBackAttempts(backElement, 2 - voiceAttempts);
    const correctWord = card.querySelector('.front img').alt;
    // Mostrar siempre el mensaje "Grabando..." al voltear a back
    showListeningIndicator(backElement, "Grabando...");
    // Solo inicia grabación si no está ya grabando
    if (!isRecording) {
        startVoiceRecognition(correctWord, backElement);
                }
            } else {
                // Si ya no quedan intentos, muestra "Incorrecto" y no inicia grabación
                backElement.innerHTML = '';
                setBackAttempts(backElement, 0, `<span style="color: #ffdddd; font-size: 2.5rem;">Incorrecto</span>`);
                backElement.classList.remove('hidden-text');
                setTimeout(() => {
                    goToNextCard();
                }, 1500);
            }
        }
    });
});
window.addEventListener('DOMContentLoaded', () => {
    showCard(currentCardIndex);
    updateCounters();
    if (audios[0]) {
        audios[0].load();
    }
});

function updateCardCounter() {
    const remaining = flashcards.length - completedCards.size;
    document.getElementById('total-cards').textContent = remaining;
}

window.addEventListener('load', () => {
    document.getElementById('soundResetButton').play().catch(e => console.log(e));
});

function stopAllAudios() {
    audios.forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
    });
}


document.getElementById('reset-button').addEventListener('click', () => {
    const soundResetButton = document.getElementById('soundResetButton');
    soundResetButton.play().catch(e => console.log(e));
    setTimeout(() => location.reload(), 500);
});

// Listener para el botón Mezclar
document.getElementById('shuffle-button').addEventListener('click', () => {
    const shuffleSound = document.getElementById('shuffleSound');
    if (shuffleSound) shuffleSound.play().catch(e => {});
    shuffleCards();
});

function setBackAttempts(backElement, attemptsLeft, mensajeExtra = "") {
    // Elimina cualquier intento anterior
    let intentosDiv = backElement.querySelector('.intentos-back');
    if (!intentosDiv) {
        intentosDiv = document.createElement('div');
        intentosDiv.className = 'intentos-back';
        intentosDiv.style.position = 'absolute';
        intentosDiv.style.top = '18px';
        intentosDiv.style.left = '0';
        intentosDiv.style.width = '100%';
        intentosDiv.style.textAlign = 'center';
        intentosDiv.style.fontSize = '1.3rem';
        intentosDiv.style.fontWeight = 'bold';
        intentosDiv.style.color = '#ffd700';
        intentosDiv.style.zIndex = '2';
        backElement.prepend(intentosDiv);
    }
    intentosDiv.innerHTML = `Intentos: ${attemptsLeft}` + (mensajeExtra ? `<br>${mensajeExtra}` : "");
}

    </script>
    
    
</body>
</html>
